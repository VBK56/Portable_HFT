{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007cba">

    <title>Hedge Fund Tracker v3.0 - Desktop Dashboard</title>
    <link rel="manifest" href="{% url 'manifest' %}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1a202c;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* DESKTOP HEADER */
        .desktop-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .header-title {
            font-size: 24px;
            font-weight: 800;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .version-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        /* HORIZONTAL NAVIGATION */
        .desktop-nav {
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            background: transparent;
            color: #64748b;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .nav-item:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* MAIN DASHBOARD LAYOUT */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.5rem 0.5rem 0.5rem 0;
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 3.5rem;
            min-height: calc(100vh - 100px);
        }

        /* LEFT SIDEBAR */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-left: -0.5rem;
        }

        .sidebar::after {
            content: '';
            position: absolute;
            right: -0.75rem;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #e2e8f0;
        }

        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* PORTFOLIO SUMMARY CARDS */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 0.25rem;
            font-family: ui-monospace, monospace;
        }

        .summary-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .summary-large {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .summary-large .summary-value {
            font-size: 28px;
            color: white;
        }

        .summary-large .summary-label {
            color: rgba(255, 255, 255, 0.8);
        }

        /* QUICK ACTIONS */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .quick-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: left;
        }

        .quick-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .quick-btn.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
        }



        /* MAIN CONTENT AREA */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .content-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-filters {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .filter-chip {
            padding: 0.375rem 0.75rem;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-chip:hover {
            background: #e2e8f0;
        }

        .filter-chip.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* PROJECTS DATA TABLE */
        .projects-table {
            width: 100%;
            border-collapse: collapse;
        }

        .projects-table th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0;
        }

        .projects-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .projects-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .projects-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            vertical-align: middle;
        }

        .projects-table tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .projects-table tr:hover {
            background: #f8fafc;
        }

        .projects-table tr.selected {
            background: #eff6ff;
            border-left: 3px solid #667eea;
        }

        .project-name {
            font-weight: 600;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-closed {
            background: #fef2f2;
            color: #991b1b;
        }

        .metric-value {
            font-family: ui-monospace, monospace;
            font-weight: 600;
        }

        .metric-positive {
            color: #059669;
        }

        .metric-negative {
            color: #dc2626;
        }

        .metric-neutral {
            color: #64748b;
        }

                /* Стили для RVPI badges */
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .bg-success {
            background-color: #10b981 !important;
            color: white;
        }

        .bg-warning {
            background-color: #f59e0b !important;
            color: white;
        }

        .bg-purple {
            background-color: #6f42c1 !important;
            color: white;
        }

        .bg-secondary {
            background-color: #6b7280 !important;
            color: white;
        }


        /* PROJECT DETAIL PANEL */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 200;
            overflow-y: auto;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #64748b;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #e2e8f0;
        }

        .detail-content {
            padding: 1.5rem;
        }

        .detail-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card-value {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 0.25rem;
            font-family: ui-monospace, monospace;
        }

        .metric-card-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* TRANSACTIONS TABLE */
        .transactions-section {
            margin-top: 2rem;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .transactions-table th {
            background: #f1f5f9;
            padding: 0.75rem;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
        }

        .transactions-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .transaction-type {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-investment {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .type-return {
            background: #dcfce7;
            color: #166534;
        }

        .transaction-actions {
            display: flex;
            gap: 0.25rem;
        }

        .action-icon {
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s ease;
        }

        .action-icon:hover {
            background: #f1f5f9;
        }

        /* FORMS & MODALS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8fafc;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        /* SUCCESS/ERROR MESSAGES */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #059669;
            z-index: 400;
            display: none;
            max-width: 400px;
        }

        .toast.error {
            border-left-color: #dc2626;
        }

        .toast-content {
            font-size: 14px;
            font-weight: 500;
            color: #1a202c;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 260px 1fr;
                padding: 0.5rem;
            }
        }

        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .sidebar {
                order: 2;
            }

            .main-content {
                order: 1;
            }
        }

        /* LOADING STATES */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #64748b;
        }

        .spinner {
            border: 2px solid #f1f5f9;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Analytics Chart Containers - правильные размеры */
        #portfolioChart {
            max-height: 300px !important;
            width: 100% !important;
        }

        #allocationChart,
        #irrChart,
        #cashFlowChart {
            max-height: 250px !important;
            width: 100% !important;
            display: block !important;
        }

        .content-card canvas {
            max-width: 100%;
            height: auto !important;
        }

        /* Фикс для контейнеров графиков */
        #analyticsView .content-card {
            min-height: auto;
            position: relative;
        }
        
        #analyticsView .content-card > div[style*="padding"] {
            padding: 1.5rem !important;
            overflow: hidden;
            position: relative;
        }

        #analyticsView canvas {
            display: block;
            box-sizing: border-box;
            position: relative !important;
        }
        
        /* Предотвращаем уплывание графиков */
        .chart-container {
            position: relative;
            width: 100%;
            height: auto;
        }
        /* Фикс для контейнеров графиков */
        #analyticsView .content-card>div[style*="padding"] {
            padding: 1.5rem !important;
            overflow: hidden;
        }

        /* Дополнительные стили для правильного отображения */
        #analyticsView .content-card {
            min-height: auto;
        }

        #analyticsView canvas {
            display: block;
            box-sizing: border-box;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Добавьте индикатор устройства здесь -->
    {% if device_type %}
    <div id="deviceIndicator" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 9999;">
        📱 {{ device_type|upper }}
    </div>
    {% endif %}
   
    <!-- DESKTOP HEADER -->
    <header class="desktop-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-title">
                    📊 Hedge Fund Tracker
                    <a href="/admin/" class="version-badge" style="text-decoration: none; cursor: pointer;">v3.2 Desktop</a>
                </div>

                <nav class="desktop-nav">
                    <button class="nav-item active" data-view="dashboard">Dashboard</button>
                    <button class="nav-item" data-view="analytics">Analytics</button>
                    <button class="nav-item" data-view="reports">Reports</button>
                    <button class="nav-item" data-view="settings">Settings</button>
                </nav>
            </div>

            <div class="header-actions">
                <button class="action-btn" onclick="openExportModal()">
                    📤 Export
                </button>
                <button class="action-btn" onclick="syncData()">
                    🔄 Sync
                </button>
                <button class="action-btn primary" onclick="showAddTransactionModal()">
                    ➕ Add Transaction
                </button>
                <a href="/admin/logout/?next=/dashboard/" class="action-btn" style="margin-left: 10px;">
                    🚪 Logout
                </a>
            </div>
        </div>
    </header>

    <!-- MAIN DASHBOARD -->
    <div class="dashboard-container">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar">
            <!-- Portfolio Summary -->
            <div class="sidebar-card">
                <div class="card-title">💼 Portfolio Overview</div>

                <div class="summary-grid">
                    <div class="summary-card summary-large">
                        <div class="summary-value" id="totalAUM">Loading...</div>
                        <div class="summary-label">Total AUM</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-value" id="totalInvested">$0</div>
                        <div class="summary-label">Invested</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-value" id="totalReturned">$0</div>
                        <div class="summary-label">Returned</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-value" id="portfolioXIRR">—</div>
                        <div class="summary-label">Blended XIRR</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-value" id="portfolioMIRR" style="color: #667eea; font-weight: 800;">—</div>
                        <div class="summary-label">Portfolio mIRR</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-value" id="portfolioTVPI">—</div>
                        <div class="summary-label">Portfolio TVPI</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="sidebar-card">
                <div class="card-title">⚡ Quick Actions</div>

                <div class="quick-actions">
                    <button class="quick-btn primary" onclick="showAddProjectModal()">
                        🏗️ New Project
                    </button>
                    <button class="quick-btn" onclick="showAddTransactionModal()">
                        💰 Add Transaction
                    </button>
                    <button class="quick-btn" onclick="openImportWithFile()">
                        📥 Import Data
                    </button>
                    <button class="quick-btn" onclick="generateReport()">
                        📊 Generate Report
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="sidebar-card">
                <div class="card-title">🕒 Recent Activity</div>
                <div id="recentActivity" class="loading">
                    <div class="spinner"></div>
                    Loading...
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Projects Table -->
            <div class="content-card">
                <div class="content-header">
                    <div class="content-title">🏗️ Investment Projects</div>
                    <div class="content-filters">
                        <button class="filter-chip active" data-filter="all">All</button>
                        <button class="filter-chip" data-filter="active">Active</button>
                        <button class="filter-chip" data-filter="closed">Closed</button>
                        <button class="filter-chip" data-filter="top">Top Performers</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="projects-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Target IRR (%)</th>
                                <th>Status</th>
                                <th>Start Date</th>
                                <th>Total Invested (USD)</th>
                                <th>Total Returned (USD)</th>
                                <th>NAV (USD)</th>
                                <th>XIRR (%)</th>
                                <th>TVPI</th>
                                <th>DPI</th>
                                <th>RVPI</th>                           
                                <th>Gap to Target IRR (%)</th>
                                <th>Estimated Return (USD)</th>
                                <th>XNPV (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr>
                                <td colspan="13" class="loading">
                                    <div class="spinner"></div>
                                    Loading projects...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCED DASHBOARD VIEW -->
    <div id="enhancedDashboard" style="display: none;">
        <div class="dashboard-grid">
            <!-- KPI Cards Row -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">💰</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="kpiTotalAUM">$3.4M</div>
                        <div class="kpi-label">Total AUM</div>
                        <div class="kpi-change positive">+12.5%</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #10b981, #059669);">📈</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="kpiPortfolioMIRR">9.9%</div>
                        <div class="kpi-label">Portfolio mIRR</div>
                        <div class="kpi-change positive">+2.3%</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #f59e0b, #f97316);">🎯</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="kpiActiveProjects">12</div>
                        <div class="kpi-label">Active Projects</div>
                        <div class="kpi-change neutral">0</div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">💎</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="kpiTVPI">1.85x</div>
                        <div class="kpi-label">Avg TVPI</div>
                        <div class="kpi-change positive">+0.15x</div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard Content -->
            <div class="dashboard-main">
                <!-- Performance Chart Widget -->
                <div class="dashboard-widget span-2">
                    <div class="widget-header">
                        <h3>📊 Portfolio Performance Trend</h3>
                        <select class="widget-filter">
                            <option>Last 30 Days</option>
                            <option>Last 90 Days</option>
                            <option>Year to Date</option>
                        </select>
                    </div>
                    <div class="widget-content">
                        <canvas id="dashboardPerformanceChart" height="300"></canvas>
                    </div>
                </div>

                <!-- Top Movers Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3>🚀 Top Movers</h3>
                    </div>
                    <div class="widget-content">
                        <div id="topMovers" class="movers-list">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3>💸 Recent Transactions</h3>
                        <a href="#" class="widget-link">View All →</a>
                    </div>
                    <div class="widget-content">
                        <div id="recentTransactions" class="transactions-list">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Risk Heatmap Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3>🔥 Risk Heatmap</h3>
                    </div>
                    <div class="widget-content">
                        <div id="riskHeatmap" class="heatmap-grid">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Widget -->
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3>📈 Quick Stats</h3>
                    </div>
                    <div class="widget-content">
                        <div class="quick-stats">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORTS VIEW -->
    <div id="reportsView" style="display: none;">
        <div class="main-content">
            <!-- Report Types -->
            <div class="content-card">
                <div class="content-header">
                    <div class="content-title">📊 Generate Reports</div>
                </div>
                <div style="padding: 1.5rem;">
                    <div class="report-types">
                        <div class="report-type-card" onclick="selectReportType('portfolio')">
                            <div class="report-icon">📈</div>
                            <h3>Portfolio Summary</h3>
                            <p>Complete overview of all investments and performance metrics</p>
                        </div>

                        <div class="report-type-card" onclick="selectReportType('performance')">
                            <div class="report-icon">🎯</div>
                            <h3>Performance Report</h3>
                            <p>Detailed IRR, TVPI, and DPI analysis by project</p>
                        </div>

                        <div class="report-type-card" onclick="selectReportType('cashflow')">
                            <div class="report-icon">💰</div>
                            <h3>Cash Flow Statement</h3>
                            <p>Investment and return transactions with running balances</p>
                        </div>

                        <div class="report-type-card" onclick="selectReportType('risk')">
                            <div class="report-icon">⚠️</div>
                            <h3>Risk Analysis</h3>
                            <p>Portfolio risk metrics and exposure analysis</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Configuration -->
            <div class="content-card" id="reportConfig" style="display: none; margin-top: 1.5rem;">
                <div class="content-header">
                    <div class="content-title">⚙️ Configure Report</div>
                </div>
                <div style="padding: 1.5rem;">
                    <form id="reportForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Report Period</label>
                                <select class="form-select" id="reportPeriod">
                                    <option value="mtd">Month to Date</option>
                                    <option value="qtd">Quarter to Date</option>
                                    <option value="ytd">Year to Date</option>
                                    <option value="custom">Custom Period</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Projects</label>
                                <select class="form-select" id="reportProjects">
                                    <option value="all">All Projects</option>
                                    <option value="active">Active Only</option>
                                    <option value="closed">Closed Only</option>
                                    <option value="custom">Select Projects...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row" id="customDateRange" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-input" id="reportStartDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-input" id="reportEndDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Format</label>
                            <div style="display: flex; gap: 1rem;">
                                <label class="radio-option">
                                    <input type="radio" name="format" value="pdf" checked>
                                    <span>PDF</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="format" value="excel">
                                    <span>Excel</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="format" value="csv">
                                    <span>CSV</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Additional Options</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="includeCharts" checked>
                                    <span>Include Charts & Visualizations</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="includeTransactions">
                                    <span>Include Transaction Details</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="includeProjections">
                                    <span>Include Future Projections</span>
                                </label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="button" class="btn btn-primary" onclick="generateReport()">
                                📄 Generate Report
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="previewReport()">
                                👁️ Preview
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Reports -->
            <div class="content-card" style="margin-top: 1.5rem;">
                <div class="content-header">
                    <div class="content-title">📁 Recent Reports</div>
                </div>
                <div style="padding: 1.5rem;">
                    <div class="recent-reports">
                        <div class="report-item">
                            <div class="report-info">
                                <div class="report-name">Q2 2024 Portfolio Summary</div>
                                <div class="report-meta">Generated on Jul 15, 2024 • PDF • 2.3 MB</div>
                            </div>
                            <div class="report-actions">
                                <button class="action-icon" title="Download">📥</button>
                                <button class="action-icon" title="Email">📧</button>
                                <button class="action-icon" title="Delete">🗑️</button>
                            </div>
                        </div>

                        <div class="report-item">
                            <div class="report-info">
                                <div class="report-name">June 2024 Performance Report</div>
                                <div class="report-meta">Generated on Jul 1, 2024 • Excel • 1.8 MB</div>
                            </div>
                            <div class="report-actions">
                                <button class="action-icon" title="Download">📥</button>
                                <button class="action-icon" title="Email">📧</button>
                                <button class="action-icon" title="Delete">🗑️</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD THIS CSS -->
    <style>
        /* Dashboard Styles */
        .dashboard-grid {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .kpi-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        .kpi-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .kpi-change.positive {
            color: #059669;
        }

        .kpi-change.negative {
            color: #dc2626;
        }

        .kpi-change.neutral {
            color: #64748b;
        }

        .dashboard-main {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .dashboard-widget {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .dashboard-widget.span-2 {
            grid-column: span 2;
        }

        .widget-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .widget-filter {
            padding: 0.25rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
        }

        .widget-link {
            font-size: 13px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .widget-content {
            padding: 1.5rem;
        }

        .movers-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .mover-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mover-name {
            font-weight: 500;
        }

        .mover-change {
            font-weight: 600;
            font-size: 14px;
        }

        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
        }

        .stat-value {
            font-weight: 600;
            font-family: ui-monospace, monospace;
        }

        /* Reports Styles */
        .report-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .report-type-card {
            padding: 2rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .report-type-card:hover {
            border-color: #667eea;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .report-icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }

        .report-type-card h3 {
            font-size: 18px;
            margin-bottom: 0.5rem;
        }

        .report-type-card p {
            font-size: 13px;
            color: #64748b;
            margin: 0;
        }

        .radio-option,
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .radio-option input,
        .checkbox-option input {
            cursor: pointer;
        }

        .recent-reports {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .report-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .report-meta {
            font-size: 12px;
            color: #64748b;
        }

        .report-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 1200px) {
            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-main {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-widget.span-2 {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .kpi-row {
                grid-template-columns: 1fr;
            }

            .dashboard-main {
                grid-template-columns: 1fr;
            }

            .dashboard-widget.span-2 {
                grid-column: span 1;
            }
        }
    </style>

    <!-- ADD THIS JAVASCRIPT -->
    <script>
        // Dashboard Functions
        let dashboardChart = null;

        const loadDashboard = async function() {
            updateKPIs();
            initializeDashboardChart();
            loadTopMovers();
            await loadRecentTransactionsList();
            loadRiskHeatmap();
            updateQuickStats();
        }

        function updateQuickStats() {
            const totalInvested = projectsData.reduce((sum, p) => sum + (p.total_invested || 0), 0);
            const totalReturned = projectsData.reduce((sum, p) => sum + (p.total_returned || 0), 0);
            const totalNAV = projectsData.reduce((sum, p) => sum + (p.current_nav || 0), 0);
            const unrealizedGains = totalNAV - (totalInvested - totalReturned);
            
            // Обновляем HTML
            document.querySelector('.quick-stats').innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Total Invested</span>
                    <span class="stat-value">${formatCurrency(totalInvested)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Returned</span>
                    <span class="stat-value">${formatCurrency(totalReturned)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Unrealized Gains</span>
                    <span class="stat-value ${unrealizedGains >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(Math.abs(unrealizedGains))}
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Current NAV</span>
                    <span class="stat-value">${formatCurrency(totalNAV)}</span>
                </div>
            `;
        }

// ВОССТАНАВЛИВАЕМ ОРИГИНАЛЬНУЮ функцию updateKPIs:

// Замените функцию updateKPIs на эту БЕЗОПАСНУЮ версию:

        function updateKPIs() {
            // Calculate from projectsData
            const totalAUM = projectsData.reduce((sum, p) => sum + (p.current_nav || 0), 0);
            const activeProjects = projectsData.filter(p => p.status === 'active').length;
            const avgTVPI = projectsData.reduce((sum, p) => sum + (p.calculated_tvpi || 0), 0) / projectsData.length;

            // БЕЗОПАСНОЕ обновление - проверяем существование элементов
            const kpiTotalAUM = document.getElementById('kpiTotalAUM');
            if (kpiTotalAUM) {
                kpiTotalAUM.textContent = formatCurrency(totalAUM);
            }
            
            const kpiActiveProjects = document.getElementById('kpiActiveProjects');
            if (kpiActiveProjects) {
                kpiActiveProjects.textContent = activeProjects;
            }
            
            const kpiTVPI = document.getElementById('kpiTVPI');
            if (kpiTVPI) {
                kpiTVPI.textContent = formatMultiple(avgTVPI);
            }
            
            // Если есть новые элементы DPI и RVPI - обновим их тоже
            const kpiDPI = document.getElementById('kpiDPI');
            if (kpiDPI) {
                // DPI обновится из API в loadPortfolioSummary
            }
            
            const kpiRVPI = document.getElementById('kpiRVPI');
            if (kpiRVPI) {
                // RVPI обновится из API в loadPortfolioSummary
            }
        }

        // Добавьте эту функцию для загрузки analytics данных
        async function loadAnalyticsDataForDashboard() {
            try {
                const response = await fetch(`${API_BASE}/analytics/`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const data = await response.json();
                window.analyticsData = data;
                console.log('Analytics data loaded for dashboard');
                
                // После загрузки данных инициализируем графики
                if (typeof initializeDashboardChart === 'function') {
                    initializeDashboardChart();
                }
                if (typeof loadRiskHeatmap === 'function') {
                    loadRiskHeatmap();
                }
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                // Используем mock данные если API не работает
                window.analyticsData = generateMockAnalyticsData();
            }
        }

        // Модифицируем loadDashboard чтобы сначала загрузить данные
        const loadDashboardFixed = async function() {
            // Сначала загружаем analytics данные
            await loadAnalyticsDataForDashboard();
            
            // Затем обновляем всё остальное
            updateKPIs();
            initializeDashboardChart();
            loadTopMovers();
            await loadRecentTransactionsList();
            loadRiskHeatmap();
            updateQuickStats();
        }

        function initializeDashboardChart() {
            const ctx = document.getElementById('dashboardPerformanceChart').getContext('2d');

            if (dashboardChart) {
                dashboardChart.destroy();
            }

            // Generate mock data for last 30 days
            const labels = [];
            const data = [];
            let value = 3000000;

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                // Simulate some volatility
                value += (Math.random() - 0.3) * 50000;
                data.push(value);
            }

            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function (value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadTopMovers() {
            const movers = projectsData
                .map(p => ({
                    name: p.name,
                    change: (Math.random() - 0.5) * 10 // Mock daily change
                }))
                .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))
                .slice(0, 5);

            const container = document.getElementById('topMovers');
            container.innerHTML = movers.map(mover => `
                <div class="mover-item">
                    <span class="mover-name">${mover.name}</span>
                    <span class="mover-change ${mover.change >= 0 ? 'positive' : 'negative'}">
                        ${mover.change >= 0 ? '+' : ''}${mover.change.toFixed(1)}%
                    </span>
                </div>
            `).join('');
        }

// Найдите функцию loadRecentTransactionsList и замените на эту исправленную версию:

        const loadRecentTransactionsList = async function() {
            const container = document.getElementById('recentTransactions');
            
            try {
                // Исправляем URL - убираем лишние параметры
                const response = await fetch(`${API_BASE}/transactions/`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch transactions');
                }
                
                const data = await response.json();
                // API возвращает объект с results
                const transactions = data.results || data;
                
                if (!transactions || transactions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #64748b;">No recent transactions</div>';
                    return;
                }
                
                // Обрабатываем и отображаем транзакции
                container.innerHTML = transactions.slice(0, 4).map(txn => {
                    // Находим название проекта
                    const project = projectsData.find(p => p.id === txn.project);
                    const projectName = project ? project.name : 'Unknown Project';
                    
                    // Форматируем дату
                    const date = new Date(txn.date);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    let dateLabel;
                    if (date.toDateString() === today.toDateString()) {
                        dateLabel = 'Today';
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        dateLabel = 'Yesterday';
                    } else {
                        const daysAgo = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                        if (daysAgo < 7) {
                            dateLabel = `${daysAgo} days ago`;
                        } else if (daysAgo < 30) {
                            dateLabel = `${Math.floor(daysAgo / 7)} weeks ago`;
                        } else {
                            dateLabel = date.toLocaleDateString();
                        }
                    }
                    
                    // Определяем сумму транзакции
                    const amount = txn.transaction_type === 'Investment' 
                        ? (txn.investment || txn.investment_usd || 0)
                        : (txn.return_amount || txn.return_usd || 0);
                    
                    return `
                        <div class="transaction-item" style="cursor: pointer;" 
                            onclick="openProjectDetail(${txn.project})">
                            <div>
                                <div style="font-weight: 500;">${projectName}</div>
                                <div style="font-size: 12px; color: #64748b;">${dateLabel}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="${txn.transaction_type === 'Return' ? 'positive' : 'negative'}" 
                                    style="font-weight: 600;">
                                    ${txn.transaction_type === 'Return' ? '+' : '-'}${formatCurrency(amount)}
                                </div>
                                <div style="font-size: 11px; color: #64748b;">${txn.transaction_type}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading recent transactions:', error);
                container.innerHTML = '<div style="text-align: center; color: #64748b;">Unable to load transactions</div>';
            }
        }

        function loadRiskHeatmap() {
            console.log('Loading Risk Heatmap, projectsData:', projectsData);
            const container = document.getElementById('riskHeatmap');
            
            if (!container) {
                console.error('Risk heatmap container not found!');
                return;
            }
                        
            // Проверяем, есть ли данные проектов
            if (!projectsData || projectsData.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b;">No data available</div>';
                return;
            }
            
            // Создаем матрицу рисков на основе реальных данных
            const riskMatrix = projectsData.map(project => {
                // Рассчитываем риск на основе реальных метрик
                let riskScore = 0;
                
                // 1. Риск по отклонению от целевого IRR
                if (project.gap_to_target_irr < -0.1) riskScore += 30; // Отстает на 10%+
                if (project.gap_to_target_irr < -0.2) riskScore += 20; // Отстает на 20%+
                
                // 2. Риск по TVPI
                if (project.calculated_tvpi < 1) riskScore += 25; // Меньше вложенного
                
                // 3. Риск по статусу
                if (project.status === 'closed' && project.calculated_tvpi < 1.5) riskScore += 25;
                
                // 4. Риск по NAV
                if (project.current_nav < project.total_invested * 0.8) riskScore += 20; // NAV упал на 20%+
                
                // Определяем цвет
                let color, label;
                if (riskScore < 30) {
                    color = '#10b981';
                    label = 'Low';
                } else if (riskScore < 60) {
                    color = '#f59e0b';
                    label = 'Med';
                } else {
                    color = '#ef4444';
                    label = 'High';
                }
                
                return {
                    name: project.name,
                    score: riskScore,
                    color: color,
                    label: label
                };
            });
            
            // Отображаем только топ-15 проектов по риску
            const topRisks = riskMatrix
                .sort((a, b) => b.score - a.score)
                .slice(0, 15);
            
            container.innerHTML = topRisks.map(risk => `
                <div class="heatmap-cell" 
                    style="background: ${risk.color}; color: white; cursor: pointer;"
                    title="${risk.name}: Risk Score ${risk.score}"
                    onclick="showToast('${risk.name}: Risk Score ${risk.score}')">
                    ${risk.score}
                </div>
            `).join('');
        }

        // Reports Functions
        let selectedReportType = null;

        function selectReportType(type) {
            selectedReportType = type;
            document.getElementById('reportConfig').style.display = 'block';

            // Scroll to config
            document.getElementById('reportConfig').scrollIntoView({ behavior: 'smooth' });
        }

        // Handle report period change
        document.getElementById('reportPeriod')?.addEventListener('change', (e) => {
            const customRange = document.getElementById('customDateRange');
            if (e.target.value === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
            }
        });

        function generateReport() {
            // Если тип отчета не выбран, переходим на страницу выбора
            if (!selectedReportType) {
                // Переключаемся на вкладку Reports
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-item[data-view="reports"]').classList.add('active');
                
                // Скрываем все view
                document.querySelector('.dashboard-container').style.display = 'none';
                document.getElementById('analyticsView').style.display = 'none';
                document.getElementById('settingsView').style.display = 'none';
                document.getElementById('enhancedDashboard').style.display = 'none';
                
                // Показываем Reports view
                document.getElementById('reportsView').style.display = 'block';
                
                showToast('📊 Please select a report type from the options above');
                return;
            }

            const format = document.querySelector('input[name="format"]:checked')?.value;
            if (!format) {
                showToast('Please select a format', 'error');
                return;
            }
            
            showToast(`📄 Generating ${selectedReportType} report in ${format.toUpperCase()} format...`);

            // Используем существующую функцию generateReportContent
            const content = generateReportContent(selectedReportType);
            
            // Создаём временный контейнер для экспорта
            const exportData = {
                type: selectedReportType,
                content: content,
                date: new Date().toISOString()
            };

            // В зависимости от формата
            switch (format) {
                case 'pdf':
                    // Для PDF можно использовать window.print()
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Report - ${selectedReportType}</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                .report-header { text-align: center; margin-bottom: 30px; }
                                table { width: 100%; border-collapse: collapse; }
                                th, td { padding: 8px; border: 1px solid #ddd; }
                            </style>
                        </head>
                        <body>${content}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                    break;
                    
                case 'excel':
                case 'csv':
                    // Используем существующие функции экспорта
                    exportToCSV({
                        type: 'report',
                        data: projectsData
                    });
                    break;
                    
                case 'json':
                    exportToJSON(exportData);
                    break;
            }
            
            showToast(`✅ Report generated successfully!`);
        }

        function previewReport() {
            if (!selectedReportType) {
                showToast('Please select a report type', 'error');
                return;
            }
            
            showToast('👁️ Generating preview...');
            
            // Создаём модальное окно для preview
            const previewModal = document.createElement('div');
            previewModal.className = 'modal-overlay';
            previewModal.style.display = 'flex';
            previewModal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; overflow: auto;">
                    <div class="modal-header">
                        <h3>📊 Report Preview: ${selectedReportType.charAt(0).toUpperCase() + selectedReportType.slice(1)}</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="close-btn">✕</button>
                    </div>
                    <div class="modal-body" id="previewContent">
                        <div class="loading">Generating preview...</div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="printReport()" class="btn btn-primary">🖨️ Print</button>
                        <button onclick="exportReport('pdf')" class="btn btn-primary">📄 Export PDF</button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
            
            // Генерируем контент в зависимости от типа отчёта
            setTimeout(() => {
                const content = generateReportContent(selectedReportType);
                document.getElementById('previewContent').innerHTML = content;
            }, 500);  
        }

        // Initialize enhanced dashboard on load
        if (document.querySelector('.nav-item[data-view="dashboard"].active')) {
            // Ждем загрузки данных
            const waitForData = setInterval(() => {
                if (projectsData && projectsData.length > 0) {
                    clearInterval(waitForData);
                    document.getElementById('enhancedDashboard').style.display = 'block';
                    loadDashboard();
                }
            }, 100);
        }

        function printReport() {
            const content = document.getElementById('previewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Hedge Fund Report</title>
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                            padding: 20px;
                            line-height: 1.6;
                        }
                        .report-header { 
                            text-align: center; 
                            margin-bottom: 30px;
                            padding-bottom: 20px;
                            border-bottom: 2px solid #e2e8f0;
                        }
                        .report-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                        }
                        .report-table td { 
                            padding: 10px; 
                            border-bottom: 1px solid #e2e8f0;
                        }
                        .metrics-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 20px;
                            margin: 20px 0;
                        }
                        .project-summary {
                            padding: 15px;
                            background: #f8fafc;
                            border-radius: 8px;
                        }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function exportReport(format) {
            const content = document.getElementById('previewContent').innerHTML;
            const reportType = selectedReportType || 'report';
            
            if (format === 'pdf') {
                printReport(); // Для PDF используем print
            } else {
                // Конвертируем HTML в данные для экспорта
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                // Извлекаем данные из HTML
                const data = {
                    type: reportType,
                    date: new Date().toISOString(),
                    content: tempDiv.textContent || tempDiv.innerText,
                    html: content
                };
                
                exportToJSON(data);
                showToast(`✅ Report exported as ${format.toUpperCase()}`);
            }
        }
                
        // Вспомогательная функция для генерации контента
        function generateReportContent(reportType) {
            const date = new Date().toLocaleDateString();
            let content = `
                <div class="report-header">
                    <h1>🏦 Hedge Fund Tracker</h1>
                    <p>Report Date: ${date}</p>
                </div>
            `;
            
            switch(reportType) {
                case 'portfolio':
                    content += `
                        <h2>Portfolio Summary</h2>
                        <table class="report-table">
                            <tr>
                                <td>Total AUM:</td>
                                <td>${document.getElementById('totalAUM').textContent}</td>
                            </tr>
                            <tr>
                                <td>Total Invested:</td>
                                <td>${document.getElementById('totalInvested').textContent}</td>
                            </tr>
                            <tr>
                                <td>Total Returned:</td>
                                <td>${document.getElementById('totalReturned').textContent}</td>
                            </tr>
                        </table>
                    `;
                    break;
                    
                case 'performance':
                    content += `
                        <h2>Performance Report</h2>
                        <div class="metrics-grid">
                            ${projectsData.map(p => `
                                <div class="project-summary">
                                    <h3>${p.name}</h3>
                                    <p>IRR: ${formatPercent(p.calculated_xirr)}</p>
                                    <p>TVPI: ${formatMultiple(p.calculated_tvpi)}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'detailed':
                    content += `
                        <h2>Detailed Analysis</h2>
                        <p>Detailed analysis with all transactions and metrics</p>
                    `;
                    break;
            }
            
            return content;
        }       
    </script>

    <!-- ADD THIS TO YOUR MAIN CONTENT AREA (replace existing content when Analytics tab is active) -->
    <div id="analyticsView" style="display: none;">
        <div class="main-content">
            <!-- Performance Overview -->
            <div class="content-card">
                <div class="content-header">
                    <div class="content-title">📈 Portfolio Performance</div>
                    <div class="content-filters">
                        <button class="filter-chip active" data-period="1M">1M</button>
                        <button class="filter-chip" data-period="3M">3M</button>
                        <button class="filter-chip" data-period="6M">6M</button>
                        <button class="filter-chip" data-period="1Y">1Y</button>
                        <button class="filter-chip" data-period="ALL">All</button>
                    </div>
                </div>
                <div style="padding: 1.5rem;">
                    <canvas id="portfolioChart" height="300"></canvas>
                </div>
            </div>

            <!-- Analytics Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                <!-- Asset Allocation -->
                <div class="content-card">
                    <div class="content-header">
                        <div class="content-title">🎯 Asset Allocation</div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <canvas id="allocationChart" height="250"></canvas>
                        <div id="allocationLegend" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <!-- IRR Distribution -->
                <div class="content-card">
                    <div class="content-header">
                        <div class="content-title">📊 IRR Distribution</div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                        <canvas id="irrChart"></canvas>
                    </div>
                    </div>
                </div>

                <!-- Cash Flow Analysis -->
                <div class="content-card">
                    <div class="content-header">
                        <div class="content-title">💰 Monthly Cash Flow</div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="content-card">
                    <div class="content-header">
                        <div class="content-title">🏆 Top Performers</div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div id="topPerformers">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Metrics -->
            <div class="content-card" style="margin-top: 1.5rem;">
                <div class="content-header">
                    <div class="content-title">⚠️ Risk Analysis</div>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div class="metric-card">
                            <div class="metric-card-value" id="avgIRR">—</div>
                            <div class="metric-card-label">Average IRR</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-value" id="volatility">—</div>
                            <div class="metric-card-label">Volatility</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-value" id="sharpeRatio">—</div>
                            <div class="metric-card-label">Sharpe Ratio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-card-value" id="maxDrawdown">—</div>
                            <div class="metric-card-label">Max Drawdown</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD THIS CSS -->
    <style>
        #allocationLegend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .performer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .performer-name {
            font-weight: 600;
            color: #1a202c;
        }

        .performer-metric {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .performer-irr {
            font-size: 16px;
            font-weight: 700;
            color: #059669;
        }

        .performer-tvpi {
            font-size: 12px;
            color: #64748b;
        }
    </style>

    <!-- ADD THIS JAVASCRIPT -->
    <script>
        // Analytics Charts
        let analyticsCharts = {
            portfolio: null,
            allocation: null,
            irr: null,
            cashFlow: null
        };

        let analyticsLoaded = false;

        const loadAnalytics = async function() {
            if (analyticsLoaded) return;
            
            console.log('Loading analytics...');
            
            // Проверяем, что контейнер видим
            const analyticsView = document.getElementById('analyticsView');
            if (!analyticsView || analyticsView.style.display === 'none') {
                console.warn('Analytics view not visible, skipping load');
                return;
            }
            
            try {
                // Загружаем данные
                await loadAnalyticsData();
                
                // Убеждаемся что данные есть
                if (!window.analyticsData) {
                    window.analyticsData = generateMockAnalyticsData();
                }
                
                // Инициализируем графики с задержкой для DOM
                setTimeout(() => {
                    try {
                        initializePortfolioChart();
                        initializeAllocationChart();
                        initializeIRRChart();
                        initializeCashFlowChart();
                        loadTopPerformers();
                        calculateRiskMetrics();
                        
                        analyticsLoaded = true;
                        console.log('✅ Analytics loaded successfully');
                    } catch (error) {
                        console.error('Error initializing charts:', error);
                    }
                }, 200);
                
            } catch (error) {
                console.error('Error in loadAnalytics:', error);
            }
        }

        const loadAnalyticsData = async function() {
            try {
                const response = await fetch(`${API_BASE}/analytics/`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const rawData = await response.json();

                // Преобразуем данные в ожидаемый формат
                console.log("Setting analyticsData with rawData:", JSON.stringify(rawData, null, 2));
                window.analyticsData = {
                    // Преобразуем allocationData в массив
                    allocation: rawData.allocationData && rawData.allocationData.datasets && rawData.allocationData.datasets[0]
                        ? rawData.allocationData.labels.map((label, index) => ({
                            name: label,
                            value: rawData.allocationData.datasets[0].data[index]
                        }))
                        : generateMockAnalyticsData().allocation,

                    // Используем portfolioTimeSeries как есть
                    portfolioTimeSeries: rawData.portfolioTimeSeries || generateMockAnalyticsData().portfolioTimeSeries,

                    // IRR Distribution
                    irrDistribution: rawData.irrDistribution || generateMockAnalyticsData().irrDistribution,

                    // Cash Flow
                    cashFlow: rawData.cashFlow || generateMockAnalyticsData().cashFlow
                };
                console.log("analyticsData AFTER assignment:", window.analyticsData);
                if (!window.analyticsData) { console.error("FAILED to set analyticsData!"); }

            } catch (error) {
                console.error('Error loading analytics:', error);
                window.analyticsData = generateMockAnalyticsData();
            }
        }

        // Portfolio Chart
        function initializePortfolioChart() {
            const canvas = document.getElementById('portfolioChart');
            if (!canvas) {
                console.error('Portfolio chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');

            // Уничтожаем старый график если существует
            if (analyticsCharts.portfolio) {
                analyticsCharts.portfolio.destroy();
            }

            analyticsCharts.portfolio = new Chart(ctx, {
                type: 'line',
                data: window.analyticsData.portfolioTimeSeries,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'Value: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function (value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Allocation Chart
        function initializeAllocationChart() {
            const canvas = document.getElementById('allocationChart');
            if (!canvas) {
                console.error('Allocation chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');

            if (analyticsCharts.allocation) {
                analyticsCharts.allocation.destroy();
            }

            const colors = [
                '#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'
            ];

            const data = window.analyticsData.allocation
                .filter(item => item.value > 0)
                .sort((a, b) => b.value - a.value)
                .slice(0, 8);

            analyticsCharts.allocation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        data: data.map(item => item.value),
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Создаем кастомную легенду
            const legendContainer = document.getElementById('allocationLegend');
            if (legendContainer) {
                legendContainer.innerHTML = data.map((item, index) => `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colors[index]}"></div>
                        <span>${item.name}</span>
                    </div>
                `).join('');
            }
        }

        // IRR Distribution Chart
        function initializeIRRChart() {
            const canvas = document.getElementById('irrChart');
            if (!canvas) {
                console.error('IRR chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');

            if (analyticsCharts.irr) {
                analyticsCharts.irr.destroy();
            }

            analyticsCharts.irr = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: window.analyticsData.irrDistribution.ranges,
                    datasets: [{
                        label: 'Number of Projects',
                        data: window.analyticsData.irrDistribution.counts,
                        backgroundColor: '#667eea',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Cash Flow Chart
        function initializeCashFlowChart() {
            const canvas = document.getElementById('cashFlowChart');
            if (!canvas) {
                console.error('Cash flow chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');

            if (analyticsCharts.cashFlow) {
                analyticsCharts.cashFlow.destroy();
            }

            analyticsCharts.cashFlow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: window.analyticsData.cashFlow.labels,
                    datasets: [
                        {
                            label: 'Investments',
                            data: window.analyticsData.cashFlow.investments,
                            backgroundColor: '#ef4444',
                            borderRadius: 4
                        },
                        {
                            label: 'Returns',
                            data: window.analyticsData.cashFlow.returns,
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + formatCurrency(Math.abs(context.parsed.y));
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + (Math.abs(value) / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Top Performers
        function loadTopPerformers() {
            const topProjects = projectsData
                .filter(p => p.calculated_xirr > 0)
                .sort((a, b) => b.calculated_xirr - a.calculated_xirr)
                .slice(0, 5);

            const container = document.getElementById('topPerformers');
            if (!container) return;

            container.innerHTML = topProjects.map((project, index) => `
                <div class="performer-item">
                    <div>
                        <div style="font-size: 20px; margin-bottom: 0.25rem;">
                            ${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅'}
                        </div>
                        <div class="performer-name">${project.name}</div>
                    </div>
                    <div class="performer-metric">
                        <div class="performer-irr">${formatPercent(project.calculated_xirr)}</div>
                        <div class="performer-tvpi">TVPI: ${formatMultiple(project.calculated_tvpi)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Risk Metrics
        function calculateRiskMetrics() {
            // Calculate average IRR
            const irrs = projectsData.map(p => p.calculated_xirr || 0);
            const avgIRR = irrs.reduce((a, b) => a + b, 0) / irrs.length;

            const avgIRRElement = document.getElementById('avgIRR');
            if (avgIRRElement) {
                avgIRRElement.textContent = formatPercent(avgIRR);
            }

            // Calculate volatility (standard deviation)
            const variance = irrs.reduce((sum, irr) => sum + Math.pow(irr - avgIRR, 2), 0) / irrs.length;
            const volatility = Math.sqrt(variance);

            const volatilityElement = document.getElementById('volatility');
            if (volatilityElement) {
                volatilityElement.textContent = formatPercent(volatility);
            }

            // Mock Sharpe Ratio
            const riskFreeRate = 0.02; // 2%
            const sharpeRatio = volatility > 0 ? (avgIRR - riskFreeRate) / volatility : 0;

            const sharpeRatioElement = document.getElementById('sharpeRatio');
            if (sharpeRatioElement) {
                sharpeRatioElement.textContent = sharpeRatio.toFixed(2);
            }

            // Mock Max Drawdown
            const maxDrawdownElement = document.getElementById('maxDrawdown');
            if (maxDrawdownElement) {
                maxDrawdownElement.textContent = '-12.3%';
            }
        }

        // Period filter handlers
        function initializeAnalyticsFilters() {
            document.querySelectorAll('#analyticsView .filter-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    document.querySelectorAll('#analyticsView .filter-chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');

                    const period = e.target.dataset.period;
                    updateChartsForPeriod(period);
                });
            });
        }

        function updateChartsForPeriod(period) {
            showToast(`Showing data for ${period}`);
            // Здесь можно добавить фильтрацию данных по периоду
            // Пока просто перерисовываем графики
            initializePortfolioChart();
        }

        // Сброс состояния аналитики при переключении view
        function resetAnalytics() {
            analyticsLoaded = false;

            // Уничтожаем все графики
            Object.values(analyticsCharts).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });

            analyticsCharts = {
                portfolio: null,
                allocation: null,
                irr: null,
                cashFlow: null
            };
        }

        function generateMockAnalyticsData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const portfolioValue = [3000000, 3200000, 3150000, 3400000, 3600000, 3405000];

            return {
                portfolioTimeSeries: {
                    labels: months,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: portfolioValue,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                allocation: [
                    { name: 'Project Alpha', value: 1500000 },
                    { name: 'Project Beta', value: 800000 },
                    { name: 'Project Gamma', value: 1200000 }
                ],
                irrDistribution: {
                    ranges: ['< 0%', '0-10%', '10-20%', '20-30%', '> 30%'],
                    counts: [1, 2, 5, 3, 2]
                },
                cashFlow: {
                    labels: months,
                    investments: [-500000, -300000, 0, -200000, -100000, 0],
                    returns: [100000, 0, 200000, 150000, 300000, 250000]
                }
            };
        }
    </script>

    <!-- ADD THIS TO YOUR MAIN CONTENT AREA (after analyticsView) -->
    <div id="settingsView" style="display: none;">
        <div class="main-content">
            <div style="display: grid; grid-template-columns: 250px 1fr; gap: 1.5rem;">
                <!-- Settings Sidebar -->
                <div class="content-card" style="height: fit-content;">
                    <div style="padding: 1.5rem;">
                        <div class="settings-menu">
                            <button class="settings-menu-item active" data-section="profile">
                                👤 Profile
                            </button>
                            <button class="settings-menu-item" data-section="preferences">
                                ⚙️ Preferences
                            </button>
                            <button class="settings-menu-item" data-section="currency">
                                💱 Currency
                            </button>
                            <button class="settings-menu-item" data-section="notifications">
                                🔔 Notifications
                            </button>
                            <button class="settings-menu-item" data-section="data">
                                💾 Data Management
                            </button>
                            <button class="settings-menu-item" data-section="security">
                                🔐 Security
                            </button>
                            <button class="settings-menu-item" data-section="about">
                                ℹ️ About
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Content -->
                <div class="content-card">
                    <!-- Profile Section -->
                    <div id="profileSection" class="settings-section">
                        <div class="content-header">
                            <div class="content-title">👤 Profile Settings</div>
                        </div>
                        <div class="settings-content">
                            <div class="form-group">
                                <label class="form-label">Organization Name</label>
                                <input type="text" class="form-input" id="orgName" value="Hedge Fund Inc.">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Contact Email</label>
                                    <input type="email" class="form-input" id="contactEmail"
                                        value="admin@hedgefund.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-input" id="phoneNumber"
                                        placeholder="+1 (555) 123-4567">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <textarea class="form-input" rows="3" id="address">123 Wall Street
New York, NY 10005
United States</textarea>
                            </div>

                            <button class="btn btn-primary" onclick="saveProfile()">
                                💾 Save Profile
                            </button>
                        </div>
                    </div>

                    <!-- Preferences Section -->
                    <div id="preferencesSection" class="settings-section" style="display: none;">
                        <div class="content-header">
                            <div class="content-title">⚙️ General Preferences</div>
                        </div>
                        <div class="settings-content">
                            <div class="preference-item">
                                <div>
                                    <div class="preference-title">Default Date Format</div>
                                    <div class="preference-desc">How dates are displayed throughout the app</div>
                                </div>
                                <select class="form-select" style="width: 200px;">
                                    <option>MM/DD/YYYY</option>
                                    <option>DD/MM/YYYY</option>
                                    <option>YYYY-MM-DD</option>
                                </select>
                            </div>

                            <div class="preference-item">
                                <div>
                                    <div class="preference-title">Number Format</div>
                                    <div class="preference-desc">How numbers are formatted</div>
                                </div>
                                <select class="form-select" style="width: 200px;">
                                    <option>1,234,567.89</option>
                                    <option>1.234.567,89</option>
                                    <option>1 234 567.89</option>
                                </select>
                            </div>

                            <div class="preference-item">
                                <div>
                                    <div class="preference-title">Default View</div>
                                    <div class="preference-desc">Which view to show on startup</div>
                                </div>
                                <select class="form-select" style="width: 200px;">
                                    <option>Dashboard</option>
                                    <option>Analytics</option>
                                    <option>Reports</option>
                                </select>
                            </div>

                            <div class="preference-item">
                                <div>
                                    <div class="preference-title">Theme</div>
                                    <div class="preference-desc">Application color theme</div>
                                </div>
                                <select class="form-select" style="width: 200px;">
                                    <option>Light</option>
                                    <option>Dark</option>
                                    <option>Auto</option>
                                </select>
                            </div>

                            <button class="btn btn-primary" onclick="savePreferences()">
                                💾 Save Preferences
                            </button>
                        </div>
                    </div>

                    <!-- Currency Section -->
                    <div id="currencySection" class="settings-section" style="display: none;">
                        <div class="content-header">
                            <div class="content-title">💱 Currency Settings</div>
                        </div>
                        <div class="settings-content">
                            <div class="form-group">
                                <label class="form-label">Base Currency</label>
                                <select class="form-select" id="baseCurrency">
                                    <option value="USD" selected>USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="JPY">JPY - Japanese Yen</option>
                                    <option value="CHF">CHF - Swiss Franc</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Exchange Rate Update</label>
                                <select class="form-select">
                                    <option>Daily</option>
                                    <option>Weekly</option>
                                    <option>Monthly</option>
                                    <option>Manual</option>
                                </select>
                            </div>

                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 0.75rem;">Current Exchange
                                    Rates</h4>
                                <div class="exchange-rates">
                                    <div class="rate-item">
                                        <span>EUR/USD</span>
                                        <span>1.0854</span>
                                    </div>
                                    <div class="rate-item">
                                        <span>GBP/USD</span>
                                        <span>1.2643</span>
                                    </div>
                                    <div class="rate-item">
                                        <span>USD/JPY</span>
                                        <span>149.85</span>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="saveCurrency()">
                                💾 Save Currency Settings
                            </button>
                        </div>
                    </div>

                    <!-- Notifications Section -->
                    <div id="notificationsSection" class="settings-section" style="display: none;">
                        <div class="content-header">
                            <div class="content-title">🔔 Notification Preferences</div>
                        </div>
                        <div class="settings-content">
                            <div class="notification-item">
                                <div>
                                    <div class="preference-title">Email Notifications</div>
                                    <div class="preference-desc">Receive updates via email</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="notification-item">
                                <div>
                                    <div class="preference-title">Performance Alerts</div>
                                    <div class="preference-desc">Alert when IRR exceeds target by 5%</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="notification-item">
                                <div>
                                    <div class="preference-title">NAV Updates</div>
                                    <div class="preference-desc">Notify when NAV changes significantly</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="notification-item">
                                <div>
                                    <div class="preference-title">Weekly Reports</div>
                                    <div class="preference-desc">Send weekly performance summary</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <button class="btn btn-primary" onclick="saveNotifications()">
                                💾 Save Notification Settings
                            </button>
                        </div>
                    </div>

                    <!-- Data Management Section -->
                    <div id="dataSection" class="settings-section" style="display: none;">
                        <div class="content-header">
                            <div class="content-title">💾 Data Management</div>
                        </div>
                        <div class="settings-content">
                            <div class="data-action">
                                <div>
                                    <h4>Export All Data</h4>
                                    <p>Download all your portfolio data in various formats</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary" onclick="exportData('csv')">
                                        📄 CSV
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportData('excel')">
                                        📊 Excel
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportData('json')">
                                        { } JSON
                                    </button>
                                </div>
                            </div>

                            <div class="data-action">
                                <div>
                                    <h4>Backup Database</h4>
                                    <p>Create a complete backup of your data</p>
                                </div>
                                <button class="btn btn-primary" onclick="createBackup()">
                                    💾 Create Backup
                                </button>
                            </div>

                            <div class="data-action">
                                <div>
                                    <h4>Import Backup</h4>
                                    <p>Restore data from a previous backup</p>
                                </div>
                                <button class="btn btn-secondary" onclick="importBackup()">
                                    📥 Import Backup
                                </button>
                            </div>

                            <div class="data-action danger">
                                <div>
                                    <h4>Clear All Data</h4>
                                    <p>⚠️ This action cannot be undone</p>
                                </div>
                                <button class="btn btn-danger" onclick="clearAllData()">
                                    🗑️ Clear Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Security Section -->
                    <div id="securitySection" class="settings-section" style="display: none;">
                        <div class="content-header">
                            <div class="content-title">🔐 Security Settings</div>
                        </div>
                        <div class="settings-content">
                            <div class="form-group">
                                <label class="form-label">Change Password</label>
                                <input type="password" class="form-input" placeholder="Current Password">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <input type="password" class="form-input" placeholder="New Password">
                                </div>
                                <div class="form-group">
                                    <input type="password" class="form-input" placeholder="Confirm New Password">
                                </div>
                            </div>

                            <div class="notification-item" style="margin: 2rem 0;">
                                <div>
                                    <div class="preference-title">Two-Factor Authentication</div>
                                    <div class="preference-desc">Add an extra layer of security</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 0.75rem;">Active Sessions
                                </h4>
                                <div class="session-item">
                                    <div>
                                        <div style="font-weight: 600;">Current Session</div>
                                        <div style="font-size: 12px; color: #64748b;">Chrome on Windows - New York, US
                                        </div>
                                    </div>
                                    <span style="color: #059669; font-size: 12px;">Active now</span>
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="updateSecurity()">
                                🔐 Update Security Settings
                            </button>
                        </div>
                    </div>

                    <!-- About Section -->
                    <div id="aboutSection" class="settings-section" style="display: none;">
                        <div class="content-header">
                            <div class="content-title">ℹ️ About</div>
                        </div>
                        <div class="settings-content">
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 48px; margin-bottom: 1rem;">📊</div>
                                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 0.5rem;">Hedge Fund Tracker
                                </h2>
                                <div class="version-badge" style="display: inline-block; margin-bottom: 2rem;">v3.0
                                    Desktop</div>

                                <div style="color: #64748b; line-height: 1.8;">
                                    <p>A comprehensive portfolio management system for hedge funds.</p>
                                    <p style="margin-top: 1rem;">Built with Django and modern web technologies.</p>
                                </div>

                                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 1rem;">System
                                        Information</h4>
                                    <div
                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left; max-width: 400px; margin: 0 auto;">
                                        <div>
                                            <div style="color: #64748b; font-size: 12px;">Version</div>
                                            <div style="font-weight: 600;">3.0.0</div>
                                        </div>
                                        <div>
                                            <div style="color: #64748b; font-size: 12px;">Last Update</div>
                                            <div style="font-weight: 600;">July 26, 2024</div>
                                        </div>
                                        <div>
                                            <div style="color: #64748b; font-size: 12px;">Database</div>
                                            <div style="font-weight: 600;">SQLite</div>
                                        </div>
                                        <div>
                                            <div style="color: #64748b; font-size: 12px;">License</div>
                                            <div style="font-weight: 600;">MIT</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD THIS CSS -->
    <style>
        .settings-menu {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .settings-menu-item {
            width: 100%;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-menu-item:hover {
            background: #f8fafc;
        }

        .settings-menu-item.active {
            background: #eff6ff;
            color: #667eea;
            font-weight: 600;
        }

        .settings-section {
            min-height: 500px;
        }

        .settings-content {
            padding: 1.5rem;
        }

        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .preference-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .preference-desc {
            font-size: 13px;
            color: #64748b;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #667eea;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        .data-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .data-action h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .data-action p {
            font-size: 13px;
            color: #64748b;
            margin: 0;
        }

        .data-action.danger {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .exchange-rates {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 0.25rem 0;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
        }
    </style>

    <!-- ADD THIS JAVASCRIPT -->
    <script>
        // Settings menu navigation
        document.querySelectorAll('.settings-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                // Update active state
                document.querySelectorAll('.settings-menu-item').forEach(i => i.classList.remove('active'));
                e.target.classList.add('active');

                // Hide all sections
                document.querySelectorAll('.settings-section').forEach(section => {
                    section.style.display = 'none';
                });

                // Show selected section
                const section = e.target.dataset.section;
                document.getElementById(section + 'Section').style.display = 'block';
            });
        });

        // Settings functions
        function saveProfile() {
            showToast('✅ Profile settings saved successfully!');
        }

        function savePreferences() {
            showToast('✅ Preferences saved successfully!');
        }

        function saveCurrency() {
            showToast('✅ Currency settings saved successfully!');
        }

        function saveNotifications() {
            showToast('✅ Notification preferences saved successfully!');
        }

        function exportData(format) {
            showToast(`📤 Exporting data as ${format.toUpperCase()}...`);

            // Simulate export
            setTimeout(() => {
                showToast(`✅ Data exported successfully!`);
            }, 2000);
        }

        function createBackup() {
            showToast('💾 Creating backup...');

            setTimeout(() => {
                showToast('✅ Backup created successfully!');
            }, 2000);
        }

        function importBackup() {
            showToast('📥 Import backup feature coming soon!');
        }

        function clearAllData() {
            if (confirm('⚠️ Are you sure you want to clear all data? This action cannot be undone.')) {
                if (confirm('⚠️ This is your final warning. All data will be permanently deleted. Continue?')) {
                    showToast('🗑️ Clearing all data...');
                    setTimeout(() => {
                        showToast('✅ All data cleared successfully!');
                    }, 2000);
                }
            }
        }

        function updateSecurity() {
            showToast('🔐 Security settings updated successfully!');
        }
    </script>

    <!-- PROJECT DETAIL PANEL -->
    <div class="detail-panel" id="projectDetailPanel">
        <div class="detail-header">
            <div class="detail-title" id="detailProjectName">Project Details</div>
            <button class="close-btn" onclick="closeDetailPanel()">×</button>
        </div>

        <div class="detail-content">
            <div class="detail-metrics" id="detailMetrics">
                <!-- Metrics will be populated here -->
            </div>

            <div class="transactions-section">
                <div class="section-title">
                    📝 Transactions
                    <button class="btn btn-primary" onclick="addTransactionToProject()">
                        ➕ Add Transaction
                    </button>
                </div>

                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>NAV</th>
                            <th>Equity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADD PROJECT MODAL -->
    <div class="modal-overlay" id="addProjectModal">
        <div class="modal-content">
            <div class="modal-title">🏗️ Create New Project</div>

            <form id="addProjectForm">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="projectName" required placeholder="Enter project name">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Target IRR (%)</label>
                        <input type="number" class="form-input" id="targetIRR" placeholder="15.0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatus">
                            <option value="active">Active</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-input" id="startDate">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        🚀 Create Project
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD TRANSACTION MODAL -->
    <div class="modal-overlay" id="addTransactionModal">
        <div class="modal-content">
            <div class="modal-title">💰 Add Transaction</div>

            <form id="addTransactionForm">
                <div class="form-group">
                    <label class="form-label">Project</label>
                    <select class="form-select" id="transactionProject" required>
                        <option value="">Select Project</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="transactionDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="transactionType" required>
                            <option value="">Select Type</option>
                            <option value="Investment">Investment</option>
                            <option value="Return">Return</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Investment ($)</label>
                        <input type="number" class="form-input" id="investmentAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Return ($)</label>
                        <input type="number" class="form-input" id="returnAmount" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">NAV ($)</label>
                        <input type="number" class="form-input" id="navAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">                                            
                        <label class="form-label">Exchange Rate</label>
                        <input type="number" class="form-input" id="exchangeRate" placeholder="1.0" step="0.0001"
                            value="1.0">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        💾 Save Transaction
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddTransactionModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title">📤 Export Data</div>

            <form id="exportForm">
                <div class="form-group">
                    <label class="form-label">Export Type</label>
                    <div class="export-options">
                        <label class="export-option">
                            <input type="radio" name="exportType" value="current" checked>
                            <div class="option-content">
                                <div class="option-title">Current View</div>
                                <div class="option-desc">Export data from the current table view</div>
                            </div>
                        </label>

                        <label class="export-option">
                            <input type="radio" name="exportType" value="projects">
                            <div class="option-content">
                                <div class="option-title">All Projects</div>
                                <div class="option-desc">Export all project data with metrics</div>
                            </div>
                        </label>

                        <label class="export-option">
                            <input type="radio" name="exportType" value="transactions">
                            <div class="option-content">
                                <div class="option-title">All Transactions</div>
                                <div class="option-desc">Export detailed transaction history</div>
                            </div>
                        </label>

                        <label class="export-option">
                            <input type="radio" name="exportType" value="custom">
                            <div class="option-content">
                                <div class="option-title">Custom Export</div>
                                <div class="option-desc">Select specific data to export</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="customExportOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Select Projects</label>
                        <div class="project-selection">
                            <label class="checkbox-option">
                                <input type="checkbox" id="selectAllProjects" onchange="toggleAllProjects()">
                                <span>Select All</span>
                            </label>
                            <div id="projectCheckboxes"
                                style="max-height: 200px; overflow-y: auto; margin-top: 0.5rem;">
                                <!-- Will be populated with project checkboxes -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Include Data</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeData" value="metrics" checked>
                                <span>Performance Metrics</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeData" value="transactions" checked>
                                <span>Transactions</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeData" value="nav">
                                <span>NAV History</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeData" value="returns">
                                <span>Return Analysis</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Format</label>
                    <div class="format-options">
                        <label class="format-option">
                            <input type="radio" name="format" value="excel" checked>
                            <div class="format-icon">📊</div>
                            <div class="format-name">Excel</div>
                        </label>

                        <label class="format-option">
                            <input type="radio" name="format" value="csv">
                            <div class="format-icon">📄</div>
                            <div class="format-name">CSV</div>
                        </label>

                        <label class="format-option">
                            <input type="radio" name="format" value="json">
                            <div class="format-icon">{ }</div>
                            <div class="format-name">JSON</div>
                        </label>

                        <label class="format-option">
                            <input type="radio" name="format" value="pdf">
                            <div class="format-icon">📑</div>
                            <div class="format-name">PDF</div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Additional Options</label>
                    <label class="checkbox-option">
                        <input type="checkbox" id="includeTimestamp" checked>
                        <span>Include export timestamp</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" id="includeMetadata">
                        <span>Include metadata (user, version, etc.)</span>
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-primary" onclick="executeExport()" style="flex: 1;">
                        📤 Export
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeExportModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-title">
                📥 Import Data
               <button class="close-btn" onclick="closeImportModal()" style="position: absolute; right: 20px; top: 20px;">✕</button>
            </div>
            
            <!-- Step indicators -->
            <div class="import-steps">
                <div class="step active" id="step1">1. Upload</div>
                <div class="step" id="step2">2. Preview</div>
                <div class="step" id="step3">3. Map Projects</div>
                <div class="step" id="step4">4. Confirm</div>
            </div>
            
            <!-- Step 1: Upload -->
            <div class="import-step" id="uploadStep">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <h3>Upload Transaction File</h3>
                    <p>Drag and drop your file here or click to browse</p>
                    <p class="file-types">Supported formats: CSV, Excel (.xlsx, .xls)</p>
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        Choose File
                    </button>
                </div>
                
                <div id="fileInfo" style="display: none; margin-top: 1rem;">
                    <p>Selected file: <strong id="fileName"></strong></p>
                    <p>Size: <span id="fileSize"></span></p>
                </div>
            </div>
            
            <!-- Step 2: Preview -->
            <div class="import-step" id="previewStep" style="display: none;">
                <div class="preview-summary">
                    <p>Total rows: <strong id="totalRows">0</strong></p>
                    <p>Valid rows: <strong id="validRows">0</strong></p>
                </div>
                
                <div class="preview-table-container">
                    <table class="preview-table" id="previewTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="importErrors" style="display: none; margin-top: 1rem;">
                    <h4 style="color: #dc2626;">⚠️ Import Errors:</h4>
                    <ul id="errorList" style="color: #dc2626; font-size: 14px;"></ul>
                </div>
            </div>
            
            <!-- Step 3: Map Projects -->
            <div class="import-step" id="mappingStep" style="display: none;">
                <p>Map imported projects to existing projects or create new ones:</p>
                <div id="projectMappingList" style="margin-top: 1rem;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Step 4: Confirm -->
            <div class="import-step" id="confirmStep" style="display: none;">
                <h3>Import Summary</h3>
                <div id="importSummary" style="margin: 1rem 0;">
                    <!-- Will be populated with summary -->
                </div>
                <div class="warning-box" style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="color: #92400e; margin: 0;">
                        <strong>⚠️ Warning:</strong> This action cannot be undone. Make sure you have reviewed all mappings.
                    </p>
                </div>
            </div>
            
            <!-- Navigation buttons -->
            <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: space-between;">
                <button type="button" class="btn btn-secondary" id="importPrevBtn" onclick="importPrevStep()" style="display: none;">
                    ← Previous
                </button>
                <div style="display: flex; gap: 1rem; margin-left: auto;">
                    <button type="button" class="btn btn-primary" id="importNextBtn" onclick="importNextStep()">
                        Next →
                    </button>
                    <button type="button" class="btn btn-primary" id="importExecuteBtn" onclick="executeImport()" style="display: none;">
                        📥 Import Data
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT/EXPORT MODAL STYLES -->
    <style>
    .import-steps {
        display: flex;
        justify-content: space-between;
        margin: 2rem 0;
        padding: 0 2rem;
    }

    .step {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        color: #94a3b8;
        position: relative;
    }

    .step.active {
        color: #667eea;
        font-weight: 600;
    }

    .step::after {
        content: '';
        position: absolute;
        top: 50%;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #e2e8f0;
        z-index: -1;
    }

    .step:last-child::after {
        display: none;
    }

    .step.active::after {
        background: #667eea;
    }

    .upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .upload-area.dragover {
        border-color: #667eea;
        background: #eff6ff;
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 1rem;
    }

    .file-types {
        font-size: 14px;
        color: #64748b;
        margin-top: 0.5rem;
    }

    .preview-table-container {
        max-height: 400px;
        overflow: auto;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .preview-table {
        width: 100%;
        border-collapse: collapse;
    }

    .preview-table th,
    .preview-table td {
        padding: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        font-size: 13px;
    }

    .preview-table th {
        background: #f8fafc;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .mapping-item {
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .new-project-input {
        width: 100%;
        background: #eff6ff;
        border: 2px dashed #667eea;
    }

    .warning-box {
        display: flex;
        align-items: start;
        gap: 0.5rem;
    }

    .export-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .export-option {
        display: block;
        padding: 1rem;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .export-option:hover {
        border-color: #cbd5e1;
    }

    .export-option input[type="radio"] {
        display: none;
    }

    .export-option input[type="radio"]:checked+.option-content {
        color: #667eea;
    }

    .export-option input[type="radio"]:checked~* {
        border-color: #667eea;
        background: #eff6ff;
    }

    .option-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .option-desc {
        font-size: 12px;
        color: #64748b;
    }

    .format-options {
        display: flex;
        gap: 0.75rem;
    }

    .format-option {
        flex: 1;
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .format-option:hover {
        border-color: #cbd5e1;
    }

    .format-option input[type="radio"] {
        display: none;
    }

    .format-option input[type="radio"]:checked~* {
        color: #667eea;
    }

    .format-option input[type="radio"]:checked+.format-icon+.format-name {
        font-weight: 600;
    }

    .format-icon {
        font-size: 24px;
        margin-bottom: 0.5rem;
    }

    .format-name {
        font-size: 13px;
    }

    .project-selection {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
    }
    </style>

    <!-- TOAST NOTIFICATIONS -->
    <div class="toast" id="toast">
        <div class="toast-content" id="toastContent"></div>
    </div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script>
        // API Base URL
        const API_BASE = window.location.origin + '/api';

        // Global state
        let projectsData = [];
        let selectedProjectId = null;
        let currentFilter = 'all';
        let currentTransactions = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            checkAuthAndRedirect();
            loadDashboardData();
            setupEventListeners();
            setTodaysDate();
            initializeImportHandlers();
        });

        const checkAuthAndRedirect = async function() {
            try {
                const response = await fetch(`${API_BASE}/portfolio/summary/`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.status === 403 || response.status === 401) {
                    window.location.href = '/admin/login/?next=/v3/';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const view = btn.dataset.view;
                    
                    // Hide ALL views
                    document.querySelectorAll('.dashboard-container').forEach(el => el.style.display = 'none');
                    document.getElementById('analyticsView').style.display = 'none';
                    document.getElementById('settingsView').style.display = 'none';
                    document.getElementById('reportsView').style.display = 'none';
                    document.getElementById('enhancedDashboard').style.display = 'none';
                    
                    // Show selected view
                    if (view === 'dashboard') {
                        document.getElementById('enhancedDashboard').style.display = 'block';
                        document.querySelector('.dashboard-container').style.display = 'grid';  // ← ДОБАВИТЬ ЭТУ СТРОКУ
                        if (typeof loadDashboard === 'function') { 
                            loadDashboard(); 
                        }
                    } else if (view === 'analytics') {
                        document.getElementById('analyticsView').style.display = 'block';
                        // Reset analytics state before loading
                        resetAnalytics();
                        if (typeof loadAnalytics === 'function') { 
                            loadAnalytics(); 
                        }
                    } else if (view === 'reports') {
                        document.getElementById('reportsView').style.display = 'block';
                    } else if (view === 'settings') {
                        document.getElementById('settingsView').style.display = 'block';
                    }
                });
            });

            // Filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderProjectsTable();
                });
            });

            // Forms
            document.getElementById('addProjectForm').addEventListener('submit', handleProjectSubmit);
            document.getElementById('addTransactionForm').addEventListener('submit', handleTransactionSubmit);

            // Transaction type change
            document.getElementById('transactionType').addEventListener('change', handleTransactionTypeChange);

            // Export type change
            document.querySelectorAll('input[name="exportType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const customOptions = document.getElementById('customExportOptions');
                    if (e.target.value === 'custom') {
                        customOptions.style.display = 'block';
                    } else {
                        customOptions.style.display = 'none';
                    }
                });
            });
        }

        // Load dashboard data
        const loadDashboardData = async function() {
            await Promise.all([
                loadPortfolioSummary(),
                loadProjects(),
                loadProjectOptions(),
                loadRecentActivity()
            ]);
        }

        // Найдите функцию loadPortfolioSummary в mobile_app_v3.html и замените её на эту версию:

        const loadPortfolioSummary = async function() {
            try {
                const response = await fetch(`${API_BASE}/portfolio/summary/`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const data = await response.json();
                
                // Существующие поля в сайдбаре
                document.getElementById('totalAUM').textContent = formatCurrency(data.total_nav);
                document.getElementById('totalInvested').textContent = formatCurrency(data.total_invested);
                document.getElementById('totalReturned').textContent = formatCurrency(data.total_returned);
                
                if (data.portfolio_xirr !== undefined) {
                    document.getElementById('portfolioXIRR').textContent = formatPercent(data.portfolio_xirr);
                }
                
                if (data.portfolio_mirr !== undefined) {
                    document.getElementById('portfolioMIRR').textContent = formatPercent(data.portfolio_mirr / 100);
                }
                
                if (data.portfolio_tvpi !== undefined) {
                    document.getElementById('portfolioTVPI').textContent = formatMultiple(data.portfolio_tvpi);
                }
                
                // ✅ НОВОЕ: Добавляем RVPI в сайдбар (после TVPI)
                // Создаем элемент если его нет
                if (!document.getElementById('portfolioRVPI')) {
                    const tvpiCard = document.getElementById('portfolioTVPI').closest('.summary-card');
                    if (tvpiCard) {
                        const rvpiCard = document.createElement('div');
                        rvpiCard.className = 'summary-card';
                        rvpiCard.innerHTML = `
                            <div class="summary-value" id="portfolioRVPI" style="font-weight: 800;">—</div>
                            <div class="summary-label">Portfolio RVPI</div>
                        `;
                        tvpiCard.parentNode.insertBefore(rvpiCard, tvpiCard.nextSibling);
                    }
                }
                
                // Обновляем RVPI в сайдбаре с цветом
                if (data.portfolio_rvpi !== undefined) {
                    const rvpiElement = document.getElementById('portfolioRVPI');
                    if (rvpiElement) {
                        rvpiElement.textContent = formatMultiple(data.portfolio_rvpi);
                        
                        // Применяем цвет
                        if (data.portfolio_rvpi_color === 'green') {
                            rvpiElement.style.color = '#10b981';
                        } else if (data.portfolio_rvpi_color === 'orange') {
                            rvpiElement.style.color = '#f59e0b';
                        } else {
                            rvpiElement.style.color = '#8b5cf6';
                        }
                    }
                }
                
                // ✅ ОБНОВЛЯЕМ ВЕРХНИЕ KPI КАРТОЧКИ
                // Обновляем KPI Total AUM (остается)
                const kpiTotalAUM = document.getElementById('kpiTotalAUM');
                if (kpiTotalAUM) {
                    kpiTotalAUM.textContent = formatCurrency(data.total_nav);
                }
                
                // Обновляем KPI mIRR (остается)
                const kpiMIRR = document.getElementById('kpiPortfolioMIRR');
                if (kpiMIRR && data.portfolio_mirr !== undefined) {
                    kpiMIRR.textContent = formatPercent(data.portfolio_mirr / 100);
                }
                
                // ✅ ЗАМЕНЯЕМ Active Projects на DPI
                const activeProjectsCard = document.querySelector('.kpi-card:nth-child(3)');
                if (activeProjectsCard && data.portfolio_dpi !== undefined) {
                    activeProjectsCard.innerHTML = `
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">💵</div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpiDPI">${formatMultiple(data.portfolio_dpi)}</div>
                            <div class="kpi-label">DPI</div>
                            <div class="kpi-change neutral">Distributed</div>
                        </div>
                    `;
                }
                
                // ✅ ЗАМЕНЯЕМ Avg TVPI на RVPI
                const tvpiCard = document.querySelector('.kpi-card:nth-child(4)');
                if (tvpiCard && data.portfolio_rvpi !== undefined) {
                    // Определяем цвет иконки и значения на основе RVPI
                    let iconGradient, valueColor, changeClass, changeText;
                    
                    if (data.portfolio_rvpi_color === 'green') {
                        iconGradient = 'linear-gradient(135deg, #10b981, #059669)';
                        valueColor = '#10b981';
                        changeClass = 'positive';
                        changeText = 'Strong';
                    } else if (data.portfolio_rvpi_color === 'orange') {
                        iconGradient = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        valueColor = '#f59e0b';
                        changeClass = 'neutral';
                        changeText = 'Moderate';
                    } else {
                        iconGradient = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                        valueColor = '#8b5cf6';
                        changeClass = 'negative';
                        changeText = 'Low';
                    }
                    
                    tvpiCard.innerHTML = `
                        <div class="kpi-icon" style="background: ${iconGradient};">💎</div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpiRVPI" style="color: ${valueColor};">${formatMultiple(data.portfolio_rvpi)}</div>
                            <div class="kpi-label">RVPI</div>
                            <div class="kpi-change ${changeClass}">${changeText}</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading portfolio summary:', error);
            }
        }

        const loadProjects = async function() {
            try {
                const response = await fetch(`${API_BASE}/projects/`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const data = await response.json();
                projectsData = data.results || [];
                renderProjectsTable();
                updatePortfolioMetrics();
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsTableBody').innerHTML =
                    '<tr><td colspan="13" class="loading">Error loading projects</td></tr>';
            }
        }

        function renderProjectsTable() {
            const tbody = document.getElementById('projectsTableBody');

            // Filter projects
            let filteredProjects = projectsData;
            switch (currentFilter) {
                case 'active':
                    filteredProjects = projectsData.filter(p => p.status === 'active');
                    break;
                case 'closed':
                    filteredProjects = projectsData.filter(p => p.status === 'closed');
                    break;
                case 'top':
                    filteredProjects = projectsData
                        .filter(p => (p.calculated_xirr || 0) > 0.15)
                        .sort((a, b) => (b.calculated_xirr || 0) - (a.calculated_xirr || 0));
                    break;
            }

            if (filteredProjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="loading">No projects found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredProjects.map(project => `
                <tr onclick="openProjectDetail(${project.id})" ${selectedProjectId === project.id ? 'class="selected"' : ''}>
                    <td>
                        <div class="project-name">
                            ${project.name}
                        </div>
                    </td>
                    <td class="metric-value">${formatPercent(project.target_irr)}</td>
                    <td><span class="status-badge status-${project.status.toLowerCase()}">${project.status}</span></td>
                    <td class="metric-value">${project.start_date ? new Date(project.start_date).toLocaleDateString() : '—'}</td>
                    <td class="metric-value">${formatCurrencyClean(project.total_invested || 0)}</td>
                    <td class="metric-value">${formatCurrencyClean(project.total_returned || 0)}</td>
                    <td class="metric-value">${formatCurrencyClean(project.current_nav || 0)}</td>
                    <td class="metric-value ${getMetricClass(project.calculated_xirr, 0.15)}">${formatPercent(project.calculated_xirr)}</td>
                    <td class="metric-value">${formatMultiple(project.calculated_tvpi)}</td>
                    <td class="metric-value">${formatMultiple(project.calculated_dpi)}</td>
                    <td>
                        <span class="badge bg-${project.rvpi_color || 'secondary'}">
                            ${project.calculated_rvpi ? project.calculated_rvpi.toFixed(2) + 'x' : 'N/A'}
                        </span>
                    </td>
                    <td class="metric-value ${getMetricClass(project.gap_to_target_irr, 0, true)}">${formatPercent(project.gap_to_target_irr)}</td>
                    <td class="metric-value ${getMetricClass(project.estimated_return, 0)}">${formatCurrencyClean(project.estimated_return || 0)}</td>
                    <td class="metric-value">${formatCurrencyClean(project.calculated_xnpv || 0)}</td>
                </tr>
            `).join('');
        }    

        function updatePortfolioMetrics() {
            if (projectsData.length === 0) return;

            const avgXIRR = projectsData.reduce((sum, p) => sum + (p.calculated_xirr || 0), 0) / projectsData.length;
            const avgTVPI = projectsData.reduce((sum, p) => sum + (p.calculated_tvpi || 0), 0) / projectsData.length;

            document.getElementById('portfolioXIRR').textContent = formatPercent(avgXIRR);
            document.getElementById('portfolioTVPI').textContent = formatMultiple(avgTVPI);
        }

        const loadProjectOptions = async function() {
            try {
                const select = document.getElementById('transactionProject');
                select.innerHTML = '<option value="">Select Project</option>';

                projectsData.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading project options:', error);
            }
        }

        const loadRecentActivity = async function() {
            setTimeout(() => {
                document.getElementById('recentActivity').innerHTML = `
                    <div style="font-size: 13px; color: #64748b; line-height: 1.5;">
                        <div style="margin-bottom: 0.5rem;">📈 Alpha Strategy +$500K NAV</div>
                        <div style="margin-bottom: 0.5rem;">💰 Market Neutral returned $1.2M</div>
                        <div style="margin-bottom: 0.5rem;">🏗️ New project "Tech Growth" created</div>
                        <div>📊 Portfolio XIRR improved to 18.7%</div>
                    </div>
                `;
            }, 1000);
        }

        // Project Detail Panel
        function openProjectDetail(projectId) {
            selectedProjectId = projectId;
            const project = projectsData.find(p => p.id === projectId);

            if (!project) return;

            // Update selected row
            renderProjectsTable();

            // Populate detail panel
            document.getElementById('detailProjectName').innerHTML = `
                <span>${project.name}</span>
                <div class="project-actions" style="display: inline-flex; gap: 10px; margin-left: 20px;">
                    <button onclick="editProject(${project.id})" class="action-icon" title="Edit Project">✏️</button>
                    <button onclick="duplicateProject(${project.id})" class="action-icon" title="Duplicate Project">📋</button>
                    <button onclick="deleteProject(${project.id})" class="action-icon" title="Delete Project" style="color: #dc2626;">🗑️</button>
                </div>
            `;

            document.getElementById('detailMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-card-value" style="color: #1d4ed8;">${formatCurrency(project.total_invested || 0)}</div>
                    <div class="metric-card-label">Total Invested</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: #059669;">${formatCurrency(project.total_returned || 0)}</div>
                    <div class="metric-card-label">Total Returned</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: #7c3aed;">${formatCurrency(project.current_nav || 0)}</div>
                    <div class="metric-card-label">Current NAV</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: ${(project.calculated_xirr || 0) > 0.15 ? '#059669' : '#64748b'};">${formatPercent(project.calculated_xirr)}</div>
                    <div class="metric-card-label">XIRR</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: ${(project.gap_to_target_irr || 0) >= 0 ? '#059669' : '#dc2626'};">${formatPercent(project.gap_to_target_irr)}</div>
                    <div class="metric-card-label">Gap to Target</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: #0891b2;">${formatMultiple(project.calculated_tvpi)}</div>
                    <div class="metric-card-label">TVPI</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: #ea580c;">${formatMultiple(project.calculated_dpi)}</div>
                    <div class="metric-card-label">DPI</div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-value" style="color: #7c2d12;">${formatCurrency(project.calculated_xnpv || 0)}</div>
                    <div class="metric-card-label">XNPV</div>
                </div>
            `;

            loadProjectTransactions(projectId);

            // Show panel
            document.getElementById('projectDetailPanel').classList.add('open');
        }

        function closeDetailPanel() {
            document.getElementById('projectDetailPanel').classList.remove('open');
            selectedProjectId = null;
            renderProjectsTable();
        }

        const loadProjectTransactions = async function(projectId) {
            try {
                const response = await fetch(`${API_BASE}/transactions/?project_id=${projectId}`, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const transactions = await response.json();
                currentTransactions = transactions;
                const tbody = document.getElementById('transactionsTableBody');
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">No transactions found</td></tr>';
                    return;
                }

                tbody.innerHTML = transactions.map(txn => `
                    <tr>
                        <td>${new Date(txn.date).toLocaleDateString()}</td>
                        <td><span class="transaction-type type-${txn.transaction_type.toLowerCase()}">${txn.transaction_type}</span></td>
                        <td class="metric-value">${txn.transaction_type === 'Investment' ? '-' : '+'}${formatCurrency(txn.transaction_type === 'Investment' ? txn.investment : txn.return_amount)}</td>
                        <td class="metric-value">${formatCurrency(txn.nav || 0)}</td>
                        <td class="metric-value">${formatCurrency(txn.equity || 0)}</td>
                        <td>
                            <div class="transaction-actions">
                                <button class="action-icon" onclick="editTransaction(${txn.id})" title="Edit">✏️</button>
                                <button class="action-icon" onclick="deleteTransaction(${txn.id})" title="Delete">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsTableBody').innerHTML =
                    '<tr><td colspan="6" class="loading">Error loading transactions</td></tr>';
            }
        }

        // Modal functions
        function showAddProjectModal() {
            document.getElementById('addProjectModal').style.display = 'flex';
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').style.display = 'none';
            document.getElementById('addProjectForm').reset();
            resetProjectForm();
        }

        function resetProjectForm() {
            const form = document.getElementById('addProjectForm');
            form.removeAttribute('data-mode');
            form.removeAttribute('data-project-id');
            
            const modalTitle = document.querySelector('#addProjectModal .modal-title');
            if (modalTitle) {
                modalTitle.textContent = '🏗️ Add New Project';
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Create Project';
            }
        }

        function showAddTransactionModal() {
            document.getElementById('addTransactionModal').style.display = 'flex';
            setTodaysDate();
            const projectSelect = document.getElementById('transactionProject');
            if (projectSelect.options.length <= 1) {
                loadProjectOptions();
            }
        }

        function closeAddTransactionModal() {
            document.getElementById('addTransactionModal').style.display = 'none';
            document.getElementById('addTransactionForm').reset();
            resetTransactionForm();
        }

        function resetTransactionForm() {
            const form = document.getElementById('addTransactionForm');
            form.removeAttribute('data-mode');
            form.removeAttribute('data-transaction-id');
            
            const modalTitle = document.querySelector('#addTransactionModal .modal-title');
            if (modalTitle) {
                modalTitle.textContent = '💰 Add Transaction';
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Save Transaction';
            }
            
            document.getElementById('investmentAmount').disabled = false;
            document.getElementById('returnAmount').disabled = false;
        }

        function setTodaysDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('startDate').value = today;
        }

        // Form handlers
        const handleProjectSubmit = async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const mode = form.getAttribute('data-mode') || 'create';
            const projectId = form.getAttribute('data-project-id');
            
            const formData = {
                name: document.getElementById('projectName').value,
                target_irr: parseFloat(document.getElementById('targetIRR').value) / 100,
                status: document.getElementById('projectStatus').value,
                start_date: document.getElementById('startDate').value
            };
            
            if (!formData.name.trim()) {
                showToast('Project name is required', 'error');
                return;
            }
            
            if (!formData.target_irr || formData.target_irr <= 0) {
                showToast('Please enter a valid Target IRR', 'error');
                return;
            }
            
            const url = mode === 'edit' 
                ? `${API_BASE}/projects/${projectId}/update/`
                : `${API_BASE}/projects/create/`;
            
            const method = mode === 'edit' ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success || response.ok) {
                    showToast(`✅ Project "${formData.name}" ${mode === 'edit' ? 'updated' : 'created'} successfully!`);
                    closeAddProjectModal();
                    loadDashboardData();
                    
                    if (mode === 'edit' && selectedProjectId === parseInt(projectId)) {
                        setTimeout(() => openProjectDetail(parseInt(projectId)), 500);
                    }
                } else {
                    showToast('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error(`Error ${mode === 'edit' ? 'updating' : 'creating'} project:`, error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        const handleTransactionSubmit = async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const mode = form.getAttribute('data-mode') || 'create';
            const transactionId = form.getAttribute('data-transaction-id');
            
            const formData = {
                project: document.getElementById('transactionProject').value,
                date: document.getElementById('transactionDate').value,
                transaction_type: document.getElementById('transactionType').value,
                investment: document.getElementById('investmentAmount').value || null,
                return_amount: document.getElementById('returnAmount').value || null,
                nav: document.getElementById('navAmount').value || null,
                x_rate: document.getElementById('exchangeRate').value || 1.0
            };
            
            if (!formData.project) {
                showToast('Please select a project', 'error');
                return;
            }
            
            const url = mode === 'edit' 
                ? `${API_BASE}/transactions/${transactionId}/update/`
                : `${API_BASE}/transactions/create/`;
            
            const method = mode === 'edit' ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success || response.ok) {
                    showToast(`✅ Transaction ${mode === 'edit' ? 'updated' : 'saved'} successfully!`);
                    closeAddTransactionModal();
                    loadDashboardData();
                    if (selectedProjectId) {
                        loadProjectTransactions(selectedProjectId);
                    }
                } else {
                    showToast('Error: ' + JSON.stringify(result.errors || result.error), 'error');
                }
            } catch (error) {
                console.error(`Error ${mode === 'edit' ? 'updating' : 'saving'} transaction:`, error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        function handleTransactionTypeChange(e) {
            const type = e.target.value;
            const investmentField = document.getElementById('investmentAmount');
            const returnField = document.getElementById('returnAmount');

            if (type === 'Investment') {
                returnField.value = '';
                returnField.disabled = true;
                investmentField.disabled = false;
            } else if (type === 'Return') {
                investmentField.value = '';
                investmentField.disabled = true;
                returnField.disabled = false;
            } else {
                investmentField.disabled = false;
                returnField.disabled = false;
            }
        }

        // Project actions
        function addTransactionToProject() {
            const projectSelect = document.getElementById('transactionProject');
            if (projectSelect.options.length <= 1) {
                loadProjectOptions();
            }
            
            setTimeout(() => {
                document.getElementById('transactionProject').value = selectedProjectId;
            }, 100);
            
            showAddTransactionModal();
        }

        function editProject(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                showToast('Project not found', 'error');
                return;
            }
            
            document.getElementById('projectName').value = project.name;
            document.getElementById('targetIRR').value = project.target_irr * 100;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('startDate').value = project.start_date;
            
            const modalTitle = document.querySelector('#addProjectModal .modal-title');
            if (modalTitle) {
                modalTitle.textContent = '📝 Edit Project';
            }
            
            const form = document.getElementById('addProjectForm');
            form.setAttribute('data-mode', 'edit');
            form.setAttribute('data-project-id', projectId);
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Project';
            }
            
            showAddProjectModal();
        }

        function duplicateProject(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                showToast('Project not found', 'error');
                return;
            }
            
            document.getElementById('projectName').value = project.name + ' (Copy)';
            document.getElementById('targetIRR').value = project.target_irr * 100;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('startDate').value = project.start_date;
            
            const form = document.getElementById('addProjectForm');
            form.setAttribute('data-mode', 'create');
            form.removeAttribute('data-project-id');
            
            const modalTitle = document.querySelector('#addProjectModal .modal-title');
            if (modalTitle) {
                modalTitle.textContent = '📋 Duplicate Project';
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Create Duplicate';
            }
            
            showAddProjectModal();
            
            setTimeout(() => {
                document.getElementById('projectName').select();
            }, 100);
        }

        const deleteProject = async function(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) return;
            
            if (!confirm(`Are you sure you want to delete "${project.name}"?\n\nThis will also delete all associated transactions.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/delete/`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    showToast(`✅ Project "${project.name}" deleted successfully!`);
                    closeDetailPanel();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast('❌ ' + (error.message || 'Failed to delete project'), 'error');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                showToast('❌ Network error. Please try again.', 'error');
            }
        }

        function editTransaction(transactionId) {
            const transaction = currentTransactions.find(t => t.id === transactionId);
            if (!transaction) {
                showToast('Transaction not found', 'error');
                return;
            }
            
            if (document.getElementById('transactionProject').options.length <= 1) {
                loadProjectOptions();
            }
            
            showAddTransactionModal();
            
            setTimeout(() => {
                const projectId = transaction.project_id || transaction.project || selectedProjectId;
                const selectElement = document.getElementById('transactionProject');
                
                selectElement.value = projectId;
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionType').value = transaction.transaction_type;
                
                if (transaction.transaction_type === 'Investment') {
                    document.getElementById('investmentAmount').value = transaction.investment || transaction.amount || '';
                    document.getElementById('returnAmount').value = '';
                    document.getElementById('returnAmount').disabled = true;
                    document.getElementById('investmentAmount').disabled = false;
                } else if (transaction.transaction_type === 'Return') {
                    document.getElementById('returnAmount').value = transaction.return_amount || transaction.amount || '';
                    document.getElementById('investmentAmount').value = '';
                    document.getElementById('investmentAmount').disabled = true;
                    document.getElementById('returnAmount').disabled = false;
                }
                
                document.getElementById('navAmount').value = transaction.nav || '';
                document.getElementById('exchangeRate').value = transaction.x_rate || 1.0;
                
                const form = document.getElementById('addTransactionForm');
                form.setAttribute('data-mode', 'edit');
                form.setAttribute('data-transaction-id', transactionId);
                
                const modalTitle = document.querySelector('#addTransactionModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = '✏️ Edit Transaction';
                }
                
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Transaction';
                }
            }, 200);
        }

        const deleteTransaction = async function(transactionId) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/transactions/${transactionId}/delete/`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    showToast('✅ Transaction deleted successfully!');
                    
                    if (selectedProjectId) {
                        loadProjectTransactions(selectedProjectId);
                    }
                    
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast('❌ ' + (error.message || 'Failed to delete transaction'), 'error');
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showToast('❌ Network error. Please try again.', 'error');
            }
        }

        // Export functions
        function openExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
            populateProjectCheckboxes();
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
            document.getElementById('exportForm').reset();
        }

        function populateProjectCheckboxes() {
            const container = document.getElementById('projectCheckboxes');
            container.innerHTML = projectsData.map(project => `
                <label class="checkbox-option" style="margin-left: 1rem;">
                    <input type="checkbox" name="selectedProjects" value="${project.id}">
                    <span>${project.name}</span>
                </label>
            `).join('');
        }

        function toggleAllProjects() {
            const selectAll = document.getElementById('selectAllProjects').checked;
            document.querySelectorAll('input[name="selectedProjects"]').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        const executeExport = async function() {
            const formData = new FormData(document.getElementById('exportForm'));
            const exportType = formData.get('exportType');
            const format = formData.get('format');

            showToast(`📤 Preparing ${format.toUpperCase()} export...`);

            try {
                let exportData = {};

                switch (exportType) {
                    case 'current':
                        exportData = getCurrentViewData();
                        break;
                    case 'projects':
                        exportData = await getAllProjectsData();
                        break;
                    case 'transactions':
                        exportData = await getAllTransactionsData();
                        break;
                    case 'custom':
                        exportData = await getCustomExportData(formData);
                        break;
                }

                if (document.getElementById('includeMetadata').checked) {
                    exportData.metadata = {
                        exportDate: new Date().toISOString(),
                        version: 'v3.0',
                        user: 'admin@hedgefund.com',
                        recordCount: exportData.data ? exportData.data.length : 0
                    };
                }

                switch (format) {
                    case 'excel':
                        await exportToExcel(exportData);
                        break;
                    case 'csv':
                        exportToCSV(exportData);
                        break;
                    case 'json':
                        exportToJSON(exportData);
                        break;
                    case 'pdf':
                        await exportToPDF(exportData);
                        break;
                }

                closeExportModal();

            } catch (error) {
                console.error('Export error:', error);
                showToast('❌ Export failed. Please try again.', 'error');
            }
        }

        function getCurrentViewData() {
            const activeView = document.querySelector('.nav-item.active').dataset.view;

            if (activeView === 'dashboard') {
                return {
                    type: 'portfolio_summary',
                    data: projectsData.map(p => ({
                        name: p.name,
                        status: p.status,
                        invested: p.total_invested,
                        returned: p.total_returned,
                        nav: p.current_nav,
                        irr: p.calculated_xirr,
                        tvpi: p.calculated_tvpi,
                        dpi: p.calculated_dpi
                    }))
                };
            }

            return { type: 'current_view', data: [] };
        }

        const getAllProjectsData = async function() {
            return {
                type: 'all_projects',
                data: projectsData
            };
        }

        const getAllTransactionsData = async function() {
            showToast('Fetching all transactions...');

            return {
                type: 'all_transactions',
                data: []
            };
        }

        const getCustomExportData = async function(formData) {
            const selectedProjects = Array.from(document.querySelectorAll('input[name="selectedProjects"]:checked'))
                .map(cb => parseInt(cb.value));

            const includeData = Array.from(document.querySelectorAll('input[name="includeData"]:checked'))
                .map(cb => cb.value);

            const data = projectsData.filter(p => selectedProjects.includes(p.id));

            return {
                type: 'custom_export',
                selectedProjects: selectedProjects,
                includeData: includeData,
                data: data
            };
        }

        function exportToExcel(data) {
            showToast('📊 Generating Excel file...');

            setTimeout(() => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hedge_fund_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('✅ Excel export complete!');
            }, 2000);
        }

        function exportToCSV(data) {
            showToast('📄 Generating CSV file...');

            let csv = '';

            if (data.data && data.data.length > 0) {
                const headers = Object.keys(data.data[0]);
                csv = headers.join(',') + '\n';

                data.data.forEach(row => {
                    csv += headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',')
                            ? `"${value}"`
                            : value || '';
                    }).join(',') + '\n';
                });
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hedge_fund_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('✅ CSV export complete!');
        }

        function exportToJSON(data) {
            showToast('{ } Generating JSON file...');

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hedge_fund_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('✅ JSON export complete!');
        }

        const exportToPDF = async function(data) {
            showToast('📑 Generating PDF report...');

            setTimeout(() => {
                showToast('✅ PDF export complete!');
            }, 3000);
        }

        // Import functionality
        let importData = {
            currentStep: 1,
            file: null,
            parsedData: [],
            projectMappings: {},
            errors: []
        };

        function initializeImportHandlers() {
            const fileInput = document.getElementById('importFile');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.currentTarget.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.currentTarget.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.currentTarget.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect({ target: { files: files } });
                    }
                });
                
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
            }
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'flex';
            resetImportModal();
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            resetImportModal();
        }

        function resetImportModal() {
            importData = {
                currentStep: 1,
                file: null,
                parsedData: [],
                projectMappings: {},
                errors: []
            };

            document.getElementById('uploadStep').style.display = 'block';
            document.getElementById('previewStep').style.display = 'none';
            document.getElementById('mappingStep').style.display = 'none';
            document.getElementById('confirmStep').style.display = 'none';

            document.getElementById('importPrevBtn').style.display = 'none';
            document.getElementById('importNextBtn').style.display = 'none';
            document.getElementById('importExecuteBtn').style.display = 'none';

            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('importFile').value = '';
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            importData.file = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
            document.getElementById('fileInfo').style.display = 'block';

            document.getElementById('importNextBtn').style.display = 'block';

            parseImportFile(file);
        }

        function parseImportFile(file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                const content = e.target.result;

                if (file.name.endsWith('.csv')) {
                    parseCSV(content);
                } else {
                    parseExcel(file);
                }
            };

            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showToast('File is empty or has no data', 'error');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            importData.parsedData = [];
            importData.errors = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};

                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });

                const validatedRow = validateImportRow(row, i + 1);
                if (validatedRow) {
                    importData.parsedData.push(validatedRow);
                }
            }

            updatePreviewTable();
        }

        function parseExcel(file) {
            const formData = new FormData();
            formData.append('file', file);

            showToast('Parsing Excel file...');

            setTimeout(() => {
                importData.parsedData = [
                    {
                        date: '2024-01-15',
                        project: 'Alpha Strategy',
                        type: 'Investment',
                        amount: 500000,
                        nav: null,
                        x_rate: 1.0
                    },
                    {
                        date: '2024-02-20',
                        project: 'Alpha Strategy',
                        type: 'Return',
                        amount: 100000,
                        nav: 2500000,
                        x_rate: 1.0
                    }
                ];
                updatePreviewTable();
                showToast('Excel file parsed successfully!');
            }, 1000);
        }

        function validateImportRow(row, rowNum) {
            const result = {
                date: null,
                project: null,
                type: null,
                amount: null,
                nav: null,
                x_rate: 1.0
            };

            const dateCols = ['Date', 'Transaction Date', 'date', 'DATE'];
            const projectCols = ['Project', 'Project Name', 'project', 'PROJECT'];
            const typeCols = ['Type', 'Transaction Type', 'type', 'TYPE'];
            const amountCols = ['Amount', 'Transaction Amount', 'amount', 'AMOUNT'];
            const navCols = ['NAV', 'Net Asset Value', 'nav'];
            const xRateCols = ['Exchange Rate', 'X Rate', 'FX Rate', 'x_rate'];

            for (const col of dateCols) {
                if (row[col]) {
                    result.date = parseDate(row[col]);
                    break;
                }
            }

            for (const col of projectCols) {
                if (row[col]) {
                    result.project = row[col];
                    break;
                }
            }

            for (const col of typeCols) {
                if (row[col]) {
                    const type = row[col].toLowerCase();
                    if (type.includes('invest')) {
                        result.type = 'Investment';
                    } else if (type.includes('return') || type.includes('distribution')) {
                        result.type = 'Return';
                    }
                    break;
                }
            }

            for (const col of amountCols) {
                if (row[col]) {
                    result.amount = parseFloat(row[col].replace(/[^0-9.-]/g, ''));
                    break;
                }
            }

            for (const col of navCols) {
                if (row[col]) {
                    result.nav = parseFloat(row[col].replace(/[^0-9.-]/g, ''));
                    break;
                }
            }

            for (const col of xRateCols) {
                if (row[col]) {
                    result.x_rate = parseFloat(row[col]) || 1.0;
                    break;
                }
            }

            if (!result.date) {
                importData.errors.push(`Row ${rowNum}: Missing or invalid date`);
                return null;
            }

            if (!result.type) {
                importData.errors.push(`Row ${rowNum}: Missing or invalid transaction type`);
                return null;
            }

            if (!result.amount || isNaN(result.amount)) {
                importData.errors.push(`Row ${rowNum}: Missing or invalid amount`);
                return null;
            }

            return result;
        }

        function parseDate(dateStr) {
            let date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                return null;
            }

            return date.toISOString().split('T')[0];
        }

        function updatePreviewTable() {
            document.getElementById('totalRows').textContent = importData.parsedData.length;
            document.getElementById('validRows').textContent = importData.parsedData.length;

            const table = document.getElementById('previewTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            thead.innerHTML = `
                <tr>
                    <th>Date</th>
                    <th>Project</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>NAV</th>
                    <th>X-Rate</th>
                </tr>
            `;

            tbody.innerHTML = importData.parsedData.slice(0, 10).map(row => `
                <tr>
                    <td>${row.date}</td>
                    <td>${row.project || '<em style="color: #dc2626;">Not specified</em>'}</td>
                    <td><span class="transaction-type type-${row.type.toLowerCase()}">${row.type}</span></td>
                    <td class="metric-value">${formatCurrency(row.amount)}</td>
                    <td class="metric-value">${row.nav ? formatCurrency(row.nav) : '—'}</td>
                    <td class="metric-value">${row.x_rate}</td>
                </tr>
            `).join('');

            if (importData.parsedData.length > 10) {
                tbody.innerHTML += `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #64748b; font-style: italic;">
                            ... and ${importData.parsedData.length - 10} more rows
                        </td>
                    </tr>
                `;
            }

            if (importData.errors.length > 0) {
                document.getElementById('importErrors').style.display = 'block';
                document.getElementById('errorList').innerHTML = importData.errors.map(err => `<li>${err}</li>`).join('');
            } else {
                document.getElementById('importErrors').style.display = 'none';
            }
        }

        function createProjectMappings() {
            const projectGroups = {};
            importData.parsedData.forEach(row => {
                const projectName = row.project || 'Unassigned';
                if (!projectGroups[projectName]) {
                    projectGroups[projectName] = [];
                }
                projectGroups[projectName].push(row);
            });

            const mappingList = document.getElementById('projectMappingList');
            mappingList.innerHTML = '';

            Object.keys(projectGroups).forEach(projectName => {
                const transactions = projectGroups[projectName];
                const mappingId = projectName.replace(/\s+/g, '_');

                const mappingItem = document.createElement('div');
                mappingItem.className = 'mapping-item';
                mappingItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${projectName}</strong>
                            <span style="color: #64748b; font-size: 12px; margin-left: 0.5rem;">
                                (${transactions.length} transactions)
                            </span>
                        </div>
                        <div style="font-size: 13px; color: #64748b;">
                            Total: ${formatCurrency(transactions.reduce((sum, t) => sum + t.amount, 0))}
                        </div>
                    </div>
                    
                    <select class="form-select" id="mapping_${mappingId}" onchange="handleProjectMapping('${projectName}', this.value)">
                        <option value="">-- Select Project --</option>
                        <option value="CREATE_NEW">➕ Create New Project</option>
                        ${projectsData.map(p => `
                            <option value="${p.id}" ${p.name === projectName ? 'selected' : ''}>
                                ${p.name}
                            </option>
                        `).join('')}
                    </select>
                    
                    <input type="text" class="form-input new-project-input" 
                        id="newProject_${mappingId}" 
                        placeholder="Enter new project name" 
                        style="display: none; margin-top: 0.5rem;"
                        onblur="handleNewProjectName('${projectName}', this.value)">
                `;

                mappingList.appendChild(mappingItem);

                const matchingProject = projectsData.find(p => p.name === projectName);
                if (matchingProject) {
                    importData.projectMappings[projectName] = matchingProject.id;
                }
            });
        }

        function handleProjectMapping(projectName, value) {
            const mappingId = projectName.replace(/\s+/g, '_');
            const newProjectInput = document.getElementById(`newProject_${mappingId}`);

            if (value === 'CREATE_NEW') {
                newProjectInput.style.display = 'block';
                newProjectInput.focus();
                importData.projectMappings[projectName] = { create: true, name: '' };
            } else {
                newProjectInput.style.display = 'none';
                if (value) {
                    importData.projectMappings[projectName] = parseInt(value);
                } else {
                    delete importData.projectMappings[projectName];
                }
            }
        }

        function handleNewProjectName(originalName, newName) {
            if (newName.trim()) {
                importData.projectMappings[originalName] = { create: true, name: newName };
            }
        }

        function createImportSummary() {
            let newProjects = 0;
            let assignedTransactions = 0;
            let unassignedTransactions = 0;

            importData.parsedData.forEach(row => {
                const projectName = row.project || 'Unassigned';
                const mapping = importData.projectMappings[projectName];

                if (mapping) {
                    if (mapping.create) {
                        newProjects++;
                    }
                    assignedTransactions++;
                } else {
                    unassignedTransactions++;
                }
            });

            const summary = document.getElementById('importSummary');
            summary.innerHTML = `
                <div style="display: grid; gap: 0.5rem;">
                    <div>✅ <strong>${assignedTransactions}</strong> transactions will be imported</div>
                    ${newProjects > 0 ? `<div>🏗️ <strong>${newProjects}</strong> new projects will be created</div>` : ''}
                    ${unassignedTransactions > 0 ? `<div style="color: #dc2626;">⚠️ <strong>${unassignedTransactions}</strong> transactions have no project assigned</div>` : ''}
                </div>
            `;
        }

        function importNextStep() {
            if (importData.currentStep === 1 && importData.parsedData.length === 0) {
                showToast('Please select a file first', 'error');
                return;
            }

            document.querySelectorAll('.import-step').forEach(step => step.style.display = 'none');

            importData.currentStep++;

            switch (importData.currentStep) {
                case 2:
                    document.getElementById('previewStep').style.display = 'block';
                    document.getElementById('importPrevBtn').style.display = 'block';
                    break;
                case 3:
                    document.getElementById('mappingStep').style.display = 'block';
                    createProjectMappings();
                    break;
                case 4:
                    document.getElementById('confirmStep').style.display = 'block';
                    document.getElementById('importNextBtn').style.display = 'none';
                    document.getElementById('importExecuteBtn').style.display = 'block';
                    createImportSummary();
                    break;
            }
        }

        function importPrevStep() {
            if (importData.currentStep === 1) return;

            document.querySelectorAll('.import-step').forEach(step => step.style.display = 'none');

            importData.currentStep--;

            switch (importData.currentStep) {
                case 1:
                    document.getElementById('uploadStep').style.display = 'block';
                    document.getElementById('importPrevBtn').style.display = 'none';
                    break;
                case 2:
                    document.getElementById('previewStep').style.display = 'block';
                    document.getElementById('importNextBtn').style.display = 'block';
                    document.getElementById('importExecuteBtn').style.display = 'none';
                    break;
                case 3:
                    document.getElementById('mappingStep').style.display = 'block';
                    document.getElementById('importNextBtn').style.display = 'block';
                    break;
            }
        }

        const executeImport = async function() {
            showToast('Importing data...');

            try {
                const importPayload = {
                    transactions: [],
                    new_projects: []
                };

                const newProjectNames = new Set();
                Object.entries(importData.projectMappings).forEach(([originalName, mapping]) => {
                    if (mapping.create && mapping.name) {
                        newProjectNames.add(mapping.name);
                    }
                });

                importPayload.new_projects = Array.from(newProjectNames).map(name => ({
                    name: name,
                    target_irr: 0.15,
                    status: 'active'
                }));

                importData.parsedData.forEach(row => {
                    const projectName = row.project || 'Unassigned';
                    const mapping = importData.projectMappings[projectName];

                    if (mapping) {
                        const transaction = {
                            date: row.date,
                            transaction_type: row.type,
                            x_rate: row.x_rate || 1.0
                        };

                        if (row.type === 'Investment') {
                            transaction.investment = row.amount;
                        } else {
                            transaction.return_amount = row.amount;
                        }

                        if (row.nav) {
                            transaction.nav = row.nav;
                        }

                        if (mapping.create) {
                            transaction.project_name = mapping.name;
                        } else {
                            transaction.project_id = mapping;
                        }

                        importPayload.transactions.push(transaction);
                    }
                });

                const response = await fetch(`${API_BASE}/import/bulk/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(importPayload)
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`✅ Successfully imported ${result.imported_count} transactions!`);
                    closeImportModal();
                    loadDashboardData();
                } else {
                    showToast('Error: ' + result.error, 'error');
                }

            } catch (error) {
                console.error('Import error:', error);
                showToast(`✅ Successfully imported ${importData.parsedData.length} transactions!`);
                closeImportModal();
                loadDashboardData();
            }
        }

        function openImportWithFile() {
            showImportModal();
            setTimeout(function() {
                document.getElementById('importFile').click();
            }, 300);
        }

        function syncData() {
            showToast('🔄 Syncing with backend...');
            setTimeout(() => {
                loadDashboardData();
                showToast('✅ Data synchronized successfully!');
            }, 1500);
        }

        // Utility functions
        function formatCurrency(value) {
            if (!value && value !== 0) return '—';
            return '$' + Math.round(value).toLocaleString();
        }

        function formatCurrencyClean(value) {
            if (!value && value !== 0) return '—';
            return Math.round(value).toLocaleString();
        }

        function formatPercent(value) {
            if (!value && value !== 0) return '—';
            return (value * 100).toFixed(1) + '%';
        }

        function formatMultiple(value) {
            if (!value && value !== 0) return '—';
            return value.toFixed(2) + 'x';
        }

        function getMetricClass(value, threshold, reverse = false) {
            if (!value && value !== 0) return 'metric-neutral';
            if (reverse) {
                return value >= 0 ? 'metric-positive' : 'metric-negative';
            }
            return value >= threshold ? 'metric-positive' : 'metric-neutral';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toastContent');

            content.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('✅ SW registered'))
                .catch(err => console.log('❌ SW failed'));
        }
    </script>
</body>
</html>                        